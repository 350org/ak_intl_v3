{% extends "./wrapper.html" %}
{% load actionkit_tags %}

{% block css_additions %}
<link href="https://dbqvwi2zcv14h.cloudfront.net/ak/donate.css" rel="stylesheet" type="text/css">
{% endblock %}

{% if templateset.custom_fields.donate_hide_paypal.strip|lower == 'y' %}
<style>
  .paypal-title{ display: none;}
</style>
{% endif %}

{% block content %}
{% if page.custom_fields.after_action_next_step == "flow" %}
{% if action.custom_fields.original_bgimage %}
<style>
#body-mobile-background {
  background-image: url('{{ action.custom_fields.original_bgimage }}') !important;
}
</style>
{% endif %}


<style>
  @media screen and (min-width:720px) {
    body:is(.Signup, .Petition, .Letter, .Donation).body-blue_opaque,
    body:is(.Signup, .Petition, .Letter, .Donation).body-white_opaque,
    body:is(.Signup, .Petition, .Letter, .Donation).body-dkgray_opaque {
      background: unset;
    }
  }

  #action-lead {
    max-width: 800px;
  }
  #donation-other, #ak-recurring-type, #in-honor-of, #site-footer, #admin-bar, #action-toc {
    display: none !important;
  }
  .ak-pagetype-donate.Donation {
    display: flex;
    flex-direction: row;
    justify-content: center;
  }
  #ak-donation-details {
    background-color: transparent !important;
    padding: 0 !important;
    width: 100%;
  }
  .ak-field-box.ak-donate-three-step {
    display: flex;
  }
  #action-header, #donate {
    text-align: left !important;
    padding: 0 !important;
    margin: 0 !important;
    width: 100%;
  }
  #action-lead .section-inner {
    display: flex;
    flex-direction: row;
    justify-content: center;
    flex-wrap: nowrap;
    padding: 48px 36px;
    border-radius: 64px;
  }
  .ak-donate-menu {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background-color: transparent;
    height: 200px;
    align-self: center;
  }
  .inline-dot {
    width: 2.5em;
    height: 2.5em;
    border-radius: 2em;
    border: 2px solid white;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }
  .ak-step-number {
    color: white;
  }
  .ak-donate-step-2::after,
  .ak-donate-step-2::before {
    content: unset;
  }
  .payments-container {
    background-color: white;
    min-width: 530px;
  }
  .ak-donate-step-1 .ak-step-number::after,
  .ak-donate-step-2 .ak-step-number::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    width: 1px;
    height: 48px;
    background-color: white;
    transform: translateX(-50%);
    z-index: 0;
  }

  .ak-donate-step-1 .ak-step-complete::after,
  .ak-donate-step-2 .ak-step-complete::after {
    content: " ";
    position: absolute;
    top: 100%;
    left: 50%;
    width: 1px;
    height: 48px;
    background-color: white;
    transform: translateX(-50%);
    z-index: 0;
  }

  #ak-donation-contact,
  .ak-donate-area-step-3 {
    margin-top: 1rem;
  }

  .ak-donate-area-step-3.ak-submit-button {
    margin-left: auto;
    margin-right: auto;
  }

  label.ak-radio-checked {
    background-color: rgb(255, 169, 2);
  }
  #ak-donation-details {
    width: 100%;
  }
  #ak-continue-button {
    margin-bottom: 1em;
  }
  .cant-donate {
    text-decoration: none;
    font-weight: bold;
    color: #fff;
    cursor: pointer;
  }
  .cant-donate:hover {
    color: white;
  }

  /* Dark Gray background overrides */
  .bg-dkgray_opaque-fade label.ak-donate-step.active-step .inline-dot {
    background: #FFFFFF1A;
  }
  .bg-dkgray_opaque-fade #ak-multi-currency, .cant-donate {
    color: #fff;
  }

  /* White background overrides */
  .bg-white_opaque-fade label.ak-donate-step .inline-dot {
    background: #ffffff;
    color: #144872;
    border-color: #144872;
  }
  .bg-white_opaque-fade #ak-multi-currency {
    color: #144872;
  }
  .bg-white_opaque-fade .ak-donate-step-1 .ak-step-number::after,
  .bg-white_opaque-fade .ak-donate-step-2 .ak-step-number::after,
  .bg-white_opaque-fade .ak-donate-step-2 .ak-step-complete::after,
  .bg-white_opaque-fade .ak-donate-step-1 .ak-step-complete::after {
    background-color: #144872 !important;
  }

  .bg-blue_opaque-fade   .section-inner { background-color: #0F81E9; color: #fff; }
  .bg-white_opaque-fade  .section-inner { background-color: #ffffff; color: #144872; }
  .bg-dkgray_opaque-fade .section-inner { background-color: #172429; color: #fff; }

  [class$="_opaque-fade"] .section-inner {
    padding: 48px 36px;
    border-radius: 64px;
    max-width: 1133px;
    display: flex;
    flex-wrap: wrap;
  }

  [class$="_opaque-fade"] .section-inner #action-header {
    max-width: 520px;
    padding:   0 24px;
    width: 100%;
  }

  [class$="_opaque-fade"] .section-inner #action-form {
    margin: auto;
  }

  [class$="_opaque-fade"] .section-inner p {
    font-family: Klima, -apple-system, BlinkMacSystemFont, Arial, sans-serif;
  }

  [class$="_opaque-fade"] .section-inner .highlight {
    border-radius: 8px;
    background:    #144872;
    height:        52px;
    padding:       12px;
    gap:           10px;
    color:         #fff;
    font-size:     24px;
    font-weight:   600;
    line-height:   normal;
  }

  [class$="_opaque-fade"] .section-inner #action-title {
    margin-top:  25px;
    font-size:   58px;
    font-weight: 400;
    line-height: normal;
  }
  .bg-dkgray_opaque-fade .section-inner .highlight {
    background: rgba(255, 255, 255, 0.10);
  }
  /* Tablet Styles */
  @media screen and (max-width:900px) {
    #jump-to-form {
      display: none;
    }
    .Donation #action-lead[class$="_opaque-fade"] {
      padding: 16px;
    }

    [class$="_opaque-fade"] .section-inner #action-header {
      margin: auto;
      max-width: 650px;
    }
  }

  /* Mobile Styles */
  @media screen and (max-width:720px) {
    #action-pretitle span.highlight {
      line-height: 2.2;
    }
    .ak-donate-menu.ak-donate-three-step {
      display: none;
    }
    #action-lead {
      min-height: unset;
      height: 100%;
    }
    #action-lead .section-inner {
      padding: 10px;
      width: 100%;
      border-radius: 0 0 24px 24px;
    }
    .payments-container {
      min-width: 300px !important;
    }
    {% if action.custom_fields.original_bgimage %}
    #body-mobile-background {
      background-image: url('{{ action.custom_fields.original_bgimage }}') !important;
    }
    {% else %}
    #body-mobile-background {
      background-image: url('{{ page.custom_fields.page_background_image }}') !important;
    }
    {% endif %}
    #ak-donation-details {
      margin: 10px;
    }
    #body-mobile-background.bg-blue_opaque,
    #body-mobile-background.bg-white_opaque,
    #body-mobile-background.bg-dkgray_opaque {
      height: 443px;
      width: calc(100% - 32px);
      left: 16px;
      border-radius: 24px;
      position: absolute;
      top: 16px;
      z-index: 10;
    }

    .body-blue_opaque {
      background: #0F81E9;
    }

    .body-white_opaque {
      background: #ffffff;
    }

    .body-dkgray_opaque {
      background: #172429;
    }
    #action-after-header {
      padding: 4rem;
    }

    [class$="_opaque-fade"] .section-inner {
      padding: 0 0 32px;
      border-radius: 0;
      z-index: 20;
      top: 228px;
    }

    .bg-blue_opaque-fade .section-inner {
      background: linear-gradient(180deg, rgba(15, 129, 233, 0) 0%, #0F81E9 5%);
    }

    .bg-white_opaque-fade .section-inner {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0) 0%, #ffffff 5%);
    }

    .bg-dkgray_opaque-fade .section-inner {
      background: linear-gradient(180deg, rgba(23, 36, 41, 0) 0%, #172429 5%);
    }

    [class$="_opaque-fade"] .section-inner #action-header {
      max-width: 100%;
      padding: 0;
    }

    [class$="_opaque-fade"] .section-inner #action-title {
      font-size: 43px;
      font-weight: 400;
      line-height: normal;
    }
  }
</style>
{% endif %}
<section id="action-lead"
  class="section donate-lead action-lead title-section width-medium padding-medium bg-{% if page.custom_fields.page_background_color %}{{ page.custom_fields.page_background_color }}{% else %}white{% endif %}{% if page.custom_fields.page_background_image %}-fade{% endif %}">
  {% if page.custom_fields.donate_enable_countdown and page.custom_fields.donate_countdown_date and page.custom_fields.donate_countdown_copy %}
  <div class="countdown">
    <p id="countdown-text" class="text-large1 text-lineheight-small2 text-strong margin-bottom-normal text-dark"><span class="text-highlight bg-dkgray-trans">
      <span class="js-countdown-timer" data-countdown-end-date="{{page.custom_fields.donate_countdown_date}}" style="line-height:1;display:inline-block;">
        <span class="js-countdown-days"></span>: <span class="js-countdown-hours"></span>: <span class="js-countdown-minutes"></span>: <span class="js-countdown-seconds"></span> 
      </span></span>
      {{page.custom_fields.donate_countdown_copy}}</p>
  </div>
  {% endif %}
  <div class="section-inner">
    {% if page.custom_fields.page_is_inactive %}
    <div id="page-inactive" class="text-center">
      {% autoescape off %}
      {{ page.custom_fields.page_is_inactive }}
      {% endautoescape %}
    </div>
    {% else %}
    {% if page.custom_fields.after_action_next_step == "flow" %}
    <div
      class="ak-donate-menu ak-donate-three-step ak-donate-three-step-visible text-center margin-bottom-none box text-small bg-white-trans">
      <label class="ak-donate-step ak-donate-step-1 active-step" for="ak-donate-step-1">
        <span class="ak-step-number strong inline-dot bg-trans">1</span>
        <span class="ak-step-complete inline-dot bg-dkgray-trans hidden">✔</span>&nbsp;<span
          class="ak-amount-label"></span>
        <input type="radio" id="ak-donate-step-1" class="hidden" name="ak-donate-step" value="1"
          checked="checked">
      </label>
      <label class="ak-donate-step ak-donate-step-2" for="ak-donate-step-2">
        <span class="ak-step-number strong inline-dot bg-trans">2</span>
        <span
          class="ak-step-complete inline-dot bg-dkgray-trans hidden">✔</span>&nbsp;<span></span>
        <input type="radio" id="ak-donate-step-2" class="hidden" name="ak-donate-step" value="2">
      </label>
      <label class="ak-donate-step ak-donate-step-3" for="ak-donate-step-3">
        <span class="ak-step-number strong inline-dot bg-trans">3</span>
        <span
          class="ak-step-complete inline-dot bg-dkgray-trans hidden">✔</span>&nbsp;<span></span>
        <input type="radio" id="ak-donate-step-3" class="hidden" name="ak-donate-step" value="3">
      </label>
    </div>
    {% endif %}
    <form id="act" name="act"
      class="{% if page.payfment_processor_information.use_tr %}braintree_form{% endif %} {{ templateset.custom_fields.donation_steps }} "
      method="POST" action="/act/" accept-charset="utf-8" autocomplete="on">
      <a id="jump-to-form" href="#donate"
        class="tablet-hide desktop-hide mobile-hide bg-orange text-underline-none text-center arrow-down text-large2">{% if page.custom_fields.form_submit_button_text %}{{ page.custom_fields.form_submit_button_text }}{% else %}{% filter ak_text:"donate_submit_button" %}Donate{% endfilter %}{% endif %}</a>
      <input type="hidden" name="page" value="{{ page.name }}">
      <input type="hidden" name="orig_akid" value="{{ akid }}">
      {% if page.custom_fields.after_action_next_step == "flow" %}
      <input id="action_original_actionid" type="hidden" name=action_original_actionid value="">
      <input id="action_original_page_name" type="hidden" name=action_original_page_name value="">
      {% if page.custom_fields.page_background_image %}
      <input id="action_original_bgimage" type="hidden" name=action_original_bgimage value="">
			{% endif %}
      <ul id="ak-errors" style="display: none;"></ul>
      <style>
        #ak-errors {
          background-color: #fff0d4;
          color: initial;
          margin: -1px 0 0;
          padding: 0.4rem 0.6rem;
          position: relative;
          display: block;
        }
        #ak-errors li {
          font-size: 0.85rem;
          line-height: 1.4;
          list-style-type: none;
        }
        #ak-errors li::before {
          background: #ffa902;
          border-radius: 1em;
          content: '';
          display: inline-block;
          height: 0.7em;
          margin-right: 0.4rem;
          width: 0.7em;
        }
      </style>
      {% endif %}
      <div id="action-header"
        class="{% if page.custom_fields.page_layout_style == 'expanded' or page.custom_fields.after_action_next_step == 'flow' %}c10{% else %}c5{% endif %} ct10 cm10 c-wide">
        {% if page.custom_fields.page_pretitle %}
        <p id="action-pretitle" class="text-font-secondary" {% if page.custom_fields.after_action_next_step == "flow" %}style="display: none;"{% endif%}><span
            class="highlight bg-dkgray-trans">{{ page.custom_fields.page_pretitle }}</span></p>
        {% endif %}
        <h2 id="action-title" class="title3 text-style-title3">
          {% if page.custom_fields.after_action_next_step == "flow" %}
            <span class="{{ page.custom_fields.page_title_style }}">
              {% if page.custom_fields.flow_donate_step_thanks_taking_action %}
              {% include_tmpl page.custom_fields.flow_donate_step_thanks_taking_action %}
              {% else %}
              Thanks for taking action, <span class="actionFirstName">friend</span>!
              {% endif %}
            </span>
          {% else %}
            {% if page.custom_fields.page_title_custom_html %}
              {% include_tmpl page.custom_fields.page_title_custom_html %}
            {% else %}
              <span class="{{ page.custom_fields.page_title_style }}">{{ page.title }}</span>
            {% endif %}
          {% endif %}
        </h2>
        {% if page.custom_fields.page_author %}
        <div class="action-author" class="margin-bottom-normal">
          {% if page.custom_fields.page_author_image %}<span class="action-author-image"><img
              src="{{ page.custom_fields.page_author_image }}"></span> {% else %}&mdash; {% endif %}<span
            class="action-author-text meta">{% autoescape off %}{{ page.custom_fields.page_author }}{% endautoescape %}</span>
        </div>
        {% endif %}

        {% comment %}If "layout" is set to "expanded", end the full-width title <div> and start a half-width description
          <div>.{% endcomment %}
            {% if page.custom_fields.page_layout_style == 'expanded' %}
          </div>
          {% endif %}

          <div id="action-description"
            class="{% if page.custom_fields.page_layout_style == 'expanded' %}{% if page.custom_fields.after_action_next_step == 'flow' %}c10{% else %}c5{% endif %} ct10 cm10{% endif %} text-large margin-top-none margin-bottom-huge">
            {% if page.custom_fields.featured_image %}
            <img class="ak-featured-img" src="{{ page.custom_fields.featured_image }}">
            {% endif %}
            <div
              {% if page.custom_fields.page_layout_style == "expanded" %}{% else %}data-read-more-after="{% if page.custom_fields.page_description_readmore %}{{ page.custom_fields.page_description_readmore }}{% else %}2{% endif %}"
              {% endif %}>
              {% include_tmpl form.ask_text %}
            </div>
          </div>

          {% comment %}If "layout" is *not* set to "expanded", end the title <div> here, after the description <div>
              .{% endcomment %}
              {% if page.custom_fields.page_layout_style != 'expanded' %}
            </div>
            {% endif %}


            {% comment %}The ID "donate" here breaks from normal naming convention so that there's a cleaner appearance
            when using it for anchor linking directly to the form.{% endcomment %}
            <div id="donate" class="action-form {% if page.custom_fields.after_action_next_step == 'flow' %}c10{% else %}c5{% endif %} ct10 cm10 c-wide margin-top-none">
              <div class="ak-field-box ak-donate-three-step">
                {% autoescape off %}
                {% if page.custom_fields.form_text_above_form %}
                <div id="form-intro" class="p text-large text-lineheight-small strong">
                  {{ page.custom_fields.form_text_above_form }}
                </div>
                {% endif %}
                {% endautoescape %}

                <!-- Render progress meter -->
                {% include "./progress_meter.html" %}
                <!--Add .ak-donate-three-step for three-step-->
                {% if page.custom_fields.after_action_next_step != "flow" %}
                  <div
                  class="ak-donate-menu ak-donate-three-step ak-donate-three-step-visible text-center margin-bottom-none box text-small bg-white-trans">
                  <label class="ak-donate-step ak-donate-step-1 active-step" for="ak-donate-step-1">
                    <span class="ak-step-number strong inline-dot bg-dkgray-trans">1</span>
                    <span class="ak-step-complete inline-dot bg-dkgray-trans hidden">✔</span>&nbsp;<span
                      class="ak-amount-label">{% filter ak_text:"donate_step_1_amount" %}Amount{% endfilter %}</span>
                    <input type="radio" id="ak-donate-step-1" class="hidden" name="ak-donate-step" value="1"
                      checked="checked">
                  </label>
                  <label class="ak-donate-step ak-donate-step-2" for="ak-donate-step-2">
                    <span class="ak-step-number strong inline-dot bg-dkgray-trans">2</span>
                    <span
                      class="ak-step-complete inline-dot bg-dkgray-trans hidden">✔</span>&nbsp;<span>{% filter ak_text:"donate_step_2_info" %}Info{% endfilter %}</span>
                    <input type="radio" id="ak-donate-step-2" class="hidden" name="ak-donate-step" value="2">
                  </label>
                  <label class="ak-donate-step ak-donate-step-3" for="ak-donate-step-3">
                    <span class="ak-step-number strong inline-dot bg-dkgray-trans">3</span>
                    <span
                      class="ak-step-complete inline-dot bg-dkgray-trans hidden">✔</span>&nbsp;<span>{% filter ak_text:"donate_step_3_payment" %}Payment{% endfilter %}</span>
                    <input type="radio" id="ak-donate-step-3" class="hidden" name="ak-donate-step" value="3">
                  </label>
                </div>
                {% endif %}
                <div id="ak-donation-details" class="box box-medium bg-white">
                  <div id="ak-product-list" class="ak-donate-area-step-1 ak-errs-below">
                    {% if has_products %}
                    <table class="ak-margin-bottom-1">
                      <thead>
                        <tr>
                          <th class="ak-product-details-header ak-small-header">Product</th>
                          <th class="ak-product-amount-header ak-small-header">Price</th>
                          <th class="ak-product-quantity-header ak-small-header">Quantity</th>
                          <th class="ak-product-quantity-header ak-small-header">Total</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for product in products %}
                          {% include "./product.html" %}
                        {% endfor %}
                      </tbody>
                    </table>

                    <p class="ak-donation-subtotal ak-align-right">
                      <label class="ak-small-header">Product Total</label>
                      <strong><span class="ak-currency-sym">{{ page.currency_sym }}</span></strong>
                      <span id="ak-donation-subtotal-amount"></span>
                    </p>

                    {% endif %}
                  </div>
                  <!--product-list-->
                  <!-- If has_candidates is true, renders option to donate to included candidates -->
                  <div id="ak-candidate-list" class="ak-donate-area-step-1 ak-errs-below">
                    {% if has_candidates %}
                    <table>
                      <thead>
                        <tr>
                          <th id="ak-candidate-details-header">Candidate</th>
                          <th>&nbsp;</th>
                          <th id="ak-candidate-amount-header">Donation</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for candidate in candidates %}
                          {% include "./candidate.html" %}
                        {% endfor %}
                      </tbody>
                    </table>
                    {% endif %}
                  </div>

                  <!-- If has_products is true, renders option to buy included products -->
                  {% if has_products %}
                  <h4 class="ak-donate-area-step-1">Donation (Optional)</h4>
                  {% endif %}
                  <div id="ak-amount-list"
                    class="ak-err-above ak-donate-area-step-1 {% for currency, account_name in page.derived.currency_accounts %}{% if forloop.first %}currency-{{ currency }}{% endif %}{% endfor %}">

                    {% if show_currency_select %}
                    <div class="ak-currency">
                      <label>
                        <select name="currency">
                          {% for code in "USD,GBP,CAD,AUD,EUR"|split:"," %}
                          {% with currency_info|get:code as currency %}
                          <option value="{{code}}">{{code}} - {{currency.name}}</option>
                          {% endwith %}
                          {% endfor %}
                          <option value="" disabled>
                            &#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;</option>
                          {% for code, currency in currency_info.items %}
                          <option value="{{code}}">{{code}} - {{currency.name}}</option>
                          {% endfor %}
                        </select>
                      </label>
                    </div>

                    {% elif page.derived.use_account_switcher %}
                    <div id="ak-multi-currency">
                      <label class="text-small2 text-caps"
                        for="amount">{% filter ak_text:"general_currency" %}Currency{% endfilter %}</label>
                      <select id="ak-currency-switcher" name="payment_account" class="ak-currencies">
                        {% for currency, account_name in page.derived.currency_accounts %}
                        <option class="ak-currency" {% if forloop.first %}checked{% endif %}
                          id="id_currency_{{currency}}" value="{{account_name}}">
                          {% if currency == "AUD" %} {% filter ak_text:"general_au_dollar" %}Australian Dollar (AUD
                          $){% endfilter %}
                          {% elif currency == "BRL" %} {% filter ak_text:"general_br_real" %}Brazilian Real (BRL
                          R$){% endfilter %}
                          {% elif currency == "CAD" %} {% filter ak_text:"general_ca_dollar" %}Canadian Dollar (CAD
                          $){% endfilter %}
                          {% elif currency == "EUR" %} {% filter ak_text:"general_eu_euro" %}Euro (EUR €){% endfilter %}
                          {% elif currency == "GBP" %} {% filter ak_text:"general_gb_pound" %}British Pound (GBP
                          £){% endfilter %}
                          {% elif currency == "USD" %} {% filter ak_text:"general_us_dollar" %}U.S. Dollar (USD
                          $){% endfilter %}
                          {% elif currency == "JPY" %} {% filter ak_text:"general_ja_yen" %}Japanese Yen (JPY ¥){% endfilter %}
                          {% elif currency == "NZD" %} {% filter ak_text:"general_nz_dollar" %}New Zealand Dollar (NZD $){% endfilter %}
                          {% elif currency == "ZAR" %} {% filter ak_text:"general_sa_rand" %}South African Rand (ZAR R){% endfilter %}
                          {% else %}
                          {{ currency }}
                          {% endif %}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                    {% endif %}

                    <script>
                      // Select currency in AK currency switcher if query param `currency` is passed through in URL
                      $(function() {
                        function urlParam(name){
                          var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
                          if (!results) { return 0; }
                          return results[1] || 0;
                        }

                        if (urlParam('currency')) {
                          $('#ak-currency-switcher').val('Braintree Client-Side Encryption ' + urlParam('currency')).change();
                        }
                      });
                    </script>
                    <div class="ak-amount-wrapper clearfix margin-bottom-small">
                      <h5 class="margin-bottom-normal ak-donate-three-step-hidden">Amount:</h5>
                      <ul class="ak-unstyled nobullet text-large">

                        {% for row in amounts|columns:1 %}
                        {% for amount in row %}
                        {% if amount == "other" %}
                        <li id="ak-other-amount-container" class="c3_3 ct3_3 cm3_3 no-margin-bottom">
                          <noscript>
                            <input type="radio" value="" class="ak-amount-radio-button" name="amount">
                          </noscript>
                          <label for="ak-other-amount-field"
                            class="input-radio-button input-radio-button-other bg-ltgray text-font-display text-large3 strong margin-bottom-small">
                            <span class="ak-currency-sym">{{ page.currency_sym }}</span>
                            <input type="number"
                              onkeypress="return (event.charCode == 8 || event.charCode == 0) ? null : event.charCode >= 48 && event.charCode <= 57"
                              id="ak-other-amount-field" class="text-font-display" name="amount_other" size="3">
                          </label>
                          <script>
                            // Measures product impressions
                            dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
                            dataLayer.push({
                              'event': 'impression',
                              'ecommerce': {
                              'impressions': [
                               {
                                 'name': 'donation',
                                 'id': 'id_donation',
                                 'list': 'ak_donation_page',
                                 'variant': 'custom',
                                 'price': 'custom',
                               }]
                              }
                            });
                            </script>              
                        </li>
                        {% else %}
                        <li class="ak-amount-container c3_3 ct3_3 cm3_3 no-margin-bottom">
                          <label for="id_amount_{{amount}}"
                            class="input-radio-button bg-ltgray text-font-display text-large3 strong margin-bottom-small">
                            <span class="ak-currency-sym">{{ page.currency_sym }}</span><span
                              class="ak-amount-button-amount">{{ amount|commify }}</span>
                            <input type="radio" id="id_amount_{{amount}}" value="{{ amount }}"
                              class="ak-amount-radio-button hidden" name="amount"
                              {% if not args.amount_other and amount == default_amount %}checked{% endif %}>
                          </label>
                          <script>
                            // Measures product impressions
                            dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
                            dataLayer.push({
                              'event': 'impression',
                              'ecommerce': {
                              'impressions': [
                               {
                                 'name': 'donation',
                                 'id': 'id_donation',
                                 'list': 'ak_donation_page',
                                 'variant': 'preset',
                                 'price': '{{amount}}',
                               }]
                              }
                            });
                            </script>              
                        </li>
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                      </ul>
                    </div>
                  </div>

                  <div id="ak-donation-total-div"></div>
                  <!-- Displays updated donation total based on selection of products/candidate donation amounts -->
                  <script type="text/ak-template" for="ak-donation-total-div">
          [% if (has_products || has_candidates) { %]
            <p class="ak-donation-total ak-donate-area-step-1">
              <label for="amount">Total Amount</label>
              <span class="ak-currency-sym">{{ page.currency_sym }}</span><span class="ak-donation-total-amount"></span>
            </p>
          [% }
          	setTimeout(update_total, 0);
          %]
      	</script>

                  {% if not has_products %}
                  {% if allow_monthly %}
                  {% if page.custom_fields.donation_once_recurring_or_both|lower == "recurring" %}
                  <div id="ak-recurring-type"></div>
                  <input type="hidden" name="donation_type" value="recurring">
                  {% elif page.custom_fields.donation_once_recurring_or_both|lower == "single" %}
                  <div id="ak-recurring-type"></div>
                  <input type="hidden" name="donation_type" value="single">
                  {% elif page.custom_fields.donation_once_recurring_or_both|lower == "both-recurring" %}
                  <!-- Toggle button, donate monthly default -->
                    {% include "./recurring_donation.html" %}
                  {% else %}
                  <!-- Toggle button, donate once default -->
                    {% include "./one_time_donation.html" %}
                  {% endif %}
                  {% else %}
                  <div id="ak-recurring-type"></div>
                  <input type="hidden" name="donation_type" value="single">
                  {% endif %}
                  {% endif %}

                  <!-- If enabled, render option to donate in honor of someone else  -->
                  {% if page.custom_fields.donation_show_inhonorof|lower == "show" %}
                    {% include "./in_honor_donation.html" %}
                  {% endif %}


                  <div id="ak-donation-contact" class="ak-donate-area-step-2 form-style-labelabove">
                    <div style="display: none">
                      <!-- Displayed when ActionKit remembers a user  -->
                      <div id="known_user">
                        Not <span id="known_user_name"></span>? <a href="?"
                          onclick="return actionkit.forms.logOut()">Click here.</a>
                      </div>
                    </div>
                    <div id="unknown_user"></div>
                    <!--
        <h5 class="margin-bottom-normal">{% filter ak_text:"donate_billing_information" %}Billing Information{% endfilter %}</h5>
        -->
                    <div class="">
                      <!--Name-->
                      <div class="name-container">
                        <div class="input-text first-name-container ak-input-type-user ak-err-below">
                          <input type="hidden" name="required" value="first_name">
                          <label for="id_first_name">{% filter ak_text:"field_first_name" %}First Name{% endfilter %}</label>
                          <input id="id_first_name" class="ak-input-type-user" type="text" name="first_name">
                        </div>
                        <div class="input-text last-name-container ak-input-type-user ak-err-below">
                          <input type="hidden" name="required" value="last_name">
                          <label for="id_last_name">{% filter ak_text:"field_last_name" %}Last Name{% endfilter %}</label>
                          <input id="id_last_name" class="ak-input-type-user" type="text" name="last_name">
                        </div>
                      </div>
                      <!--Email-->
                      <div class="input-text ak-input-type-user input-field-group ak-err-below">
                        <label class="required"
                          for="id_email">{% filter ak_text:"field_email" %}Email{% endfilter %}</label>
                        <input id="id_email" class="" type="text" name="email">
                      </div>
                      {% if page.allow_international %}
                      <div class="input-select input-country ak-input-type-user input-field-group ak-err-below">
                        <label for="country">{% filter ak_text:"field_country" %}Country{% endfilter %}</label>
                        {% include "./country_select.html" %}
                      </div>
                      {% else %}
                      <input type="hidden" name="country" value="United States">
                      {% endif %}
                      {% if page.lang_or_en.iso_code == 'ja' %}
                        {% include "./japanese_address_fields.html" %}
                      {% else %}
                        {% include "./default_address_fields.html" %}
                      {% endif %}
                    </div>
                    {% include "./privacy.html" %}

                    <!-- Render occupation and employer fields, if required -->
                    {% if templateset.custom_fields.ask_occupation_and_employer %}
                    <p class="ak-label-above text-small" id="ak-occ-emp-why">
                      Federal law requires us to use our best efforts to collect and report the name, mailing address,
                      occupation and name of employer of individuals whose contributions aggregate in excess of $200 in
                      a calendar year.
                    </p>
                    <div class="ak-errs-below">
                      <div class="input-text ak-input-type-action input-field-group">
                        <label for="action_employer">Employer</label>
                        <input id="action_employer" class="" type="text" name="action_employer" size="20">
                        <input type="hidden" name="required" value="action_employer">
                      </div>
                      <div class="input-text ak-input-type-action input-field-group">
                        <label for="action_occupation">Occupation</label>
                        <input id="action_occupation" type="text" name="action_occupation" size="20">
                        <input type="hidden" name="required" value="action_occupation">
                      </div>
                    </div>
                    {% endif %}

                    <!-- Render shipping address inputs if products need to be shipped -->
                    {% if has_shippable_products %}
                    <div id="ak-shipping-address">
                      {% include "./shipping_address.html" %}
                    </div> <!-- shipping address -->
                    {% endif %}
                  </div> <!-- donation contact -->

                  <div class="ak-donate-area-step-3 form-style-labelabove ak-errs-below">
                    <!-- <h5 class="margin-bottom-normal">{% filter ak_text:"donate_payment_information" %}Payment Information{% endfilter %}</h5> -->
                    <div class="payments-container">
                      <div class="payments-titles">
                        <!-- Render non Paypal payment icons -->
                        {% if not page.custom_fields.donation_only_paypal or page.custom_fields.donation_only_paypal.strip|lower != 'y'  %}

                        <div
                          class="payments-title {% if page.custom_fields.donation_payment_type_appearance.strip|lower == 'y' %}payment-title-button{% endif %} payments-title-active card-title ">
                          <svg width="150" height="40" class="payments-title-active cards-us">
                            <image href=https://dkaroyc5da26m.cloudfront.net/images/cards.svg width="150" height="40" />
                          </svg>
                          <svg width="75" height="40" class="payments-title-active cards-non-us" style="display:none;">
                            <image href="https://dbqvwi2zcv14h.cloudfront.net/images/cards-visa-mc.svg" width="75" height="40" />
                          </svg>
                        </div>
                        {% if templateset.custom_fields.donate_hide_paypal.strip|lower != 'y' %}
                        <div
                          class="payments-title {% if page.custom_fields.donation_payment_type_appearance.strip|lower == 'y' %}payment-title-button{% endif %} paypal-title">
                          <svg width="75" height="40">
                            <image href=https://dkaroyc5da26m.cloudfront.net/images/paypal-logo.svg width="75"
                              height="40" />
                          </svg>
                        </div>
                        {% endif %}
                        {% endif %}
                        <!-- Render Paypal payment icon -->
                        {% if page.custom_fields.donation_only_paypal or page.custom_fields.donation_only_paypal.strip|lower == 'y'  %} 
                        <div class="payments-title payments-title-active paypal-title paypal-only">
                          <svg width="75" height="40">
                            <image href=https://dkaroyc5da26m.cloudfront.net/images/paypal-logo.svg width="75"
                              height="40" />
                          </svg>
                        </div>
                        {% endif %}
                      </div>
                      <div id="payments-details-content">

                      </div>
                    </div>

                    <!--Credit Card-->
                    {% comment %} Show the Credit Card Fields only when the custom field for donation_only_paypal is
                    {% endcomment %}
                    {% if not page.custom_fields.donation_only_paypal or page.custom_fields.donation_only_paypal.strip|lower != 'y'  %}
                      {% include "./credit_card.html" %}
                    {% endif %}


                    {% autoescape off %}
                    {% if page.custom_fields.form_additional_fields %}
                    <div class="addl-html text-small">
                      {{ page.custom_fields.form_additional_fields }}
                    </div>
                    {% endif %}
                    {% endautoescape %}

                    <!-- Render pre submit text -->
                    {% if templateset.custom_fields.pre_submit_text %}
                    <div class="pre-submit-text">
                      {% autoescape off %}
                      {{ templateset.custom_fields.pre_submit_text }}
                      {% endautoescape %}
                    </div>
                    {% endif %}
                    <!-- Render "Pay by Paypal" option -->
                    {% if show_paypal or page.custom_fields.donation_only_paypal or page.custom_fields.donation_only_paypal.strip|lower == 'y'%}
                    <div class="ak-payment-options text-center ak-donate-area-step-3 paypal-fields">
                      <input type="hidden" name="paypal" value="0" id="ak-pay-by-paypal">
                      <p class="margin-bottom-small text-small">
                        <button type="submit" id="ak-paypal-button" class="button paypal-fields">
                          {% filter ak_text:"continue_with_paypal" %} Continue with PayPal {% endfilter %}
                        </button></p>
                    </div>

                    <!-- Render post submission text -->
                    {% if page.custom_fields.post_submit_text %}
                    <div class="post-submit-text">
                      {% autoescape off %}
                      {{ page.custom_fields.post_submit_text }}
                      {% endautoescape %}
                    </div>
                    {% endif %}


                    {% endif %}

                  </div>
                  <!--ak-styled-fields-->


                  <div class="text-center">
                    <button class="ak-styled-submit-button arrow-right button ak-donate-three-step-visible"
                      id="ak-continue-button">{% filter ak_text:"donate_button_continue" %}Continue
                      &rarr;{% endfilter %}</button>

                    {% if page.payment_processor_information.use_cse %}
                    {% comment %}
                    For pages that use CSE, the submit button will be enabled by javascript above.
                    {% endcomment %}

                    <button disabled="true" type="submit"
                      class="ak-submit-button button ak-donate-area-step-3 margin-bottom-normal cc-fields">{% if page.custom_fields.form_submit_button_text %}{{ page.custom_fields.form_submit_button_text }}{% else %}{% filter ak_text:"donate_submit_button" %}Donate{% endfilter %}{% endif %}
                      <span class="ak-currency-sym">{{ page.currency_sym }}</span><span
                        class="ak-donation-total-amount"></span>&nbsp;<span
                        class="ak-donation-monthly">{% filter ak_text:"donate_monthly" %}monthly{% endfilter %}</span></button>
                    <noscript>
                      <p><b>JavaScript is required</b> so this page can securely submit your donation.</p>
                    </noscript>
                    {% else %}
                    <button type="submit"
                      class="ak-submit-button button ak-donate-area-step-3 margin-bottom-normal cc-fields">{% if page.custom_fields.form_submit_button_text %}{{ page.custom_fields.form_submit_button_text }}{% else %}{% filter ak_text:"donate_submit_button" %}Donate{% endfilter %}{% endif %}
                      <span class="ak-currency-sym">{{ page.currency_sym }}</span><span
                        class="ak-donation-total-amount"></span>&nbsp;<span
                        class="ak-donation-monthly">{% filter ak_text:"donate_monthly" %}monthly{% endfilter %}</span></button>
                    {% endif %}
                  </div>
                  {% if page.custom_fields.after_action_next_step == "flow" %}
                  <div class="cant-donate-container">
                    <p class="text-center cant-donate">
                      I can't donate right now >
                    </p>
                  </div>
                  {% endif %}
                </div>
              </div>
              <div id="action-toc" class="text-small icon-before icon-faded" data-icon="&#xE93E;">
                <strong>{% filter ak_text:"donate_secure_donation" %}Secure donation{% endfilter %}.</strong>
                {% if page.custom_fields.form_short_toc %}{% autoescape off %}{{ page.custom_fields.form_short_toc }}{% endautoescape %}{% else %}Your
                contribution will support 350.org groups all over the world working to build a better, climate-safe
                future.{% endif %}
                <span style="display:none;"
                  class="privacy-non_eu">{% filter ak_text:"general_opt_in_privacy_notice_non_eu" %}350 will send you
                  email updates when you can make a difference.{% endfilter %}</span>
              </div>
            </div>
    </form>
    {% endif %}
  </div>
</section>

<div id="donation-other"
  class="section padding-medium width-normal bg-{% if page.custom_fields.page_background_color %}{{ page.custom_fields.page_background_color }}{% else %}white{% endif %}">
  <!-- Render all donation disclaimers -->
  {% include "./donation_disclaimers.html" %}
</div>

{% endblock %}

{% block script_additions %}

{% if page.custom_fields.donate_payment_frequency_above_amounts.strip|lower == 'y' %}
<script>
  $(function () {
    $('#ak-recurring-type').insertBefore('#ak-amount-list');
    $('#ak-recurring-type').addClass('paymenttype-above');
  });
</script>
{% endif %}

{% if page.custom_fields.donate_enable_countdown and page.custom_fields.donate_countdown_date %}
<!-- Add JS for countdown if enabled -->
<script type="text/javascript" justification="script for countdown">
  /*!
  * The Final Countdown for jQuery v2.1.0 (http://hilios.github.io/jQuery.countdown/)
  * Copyright (c) 2015 Edson Hilios
  */
  /* End date/time format:
      YYYY/MM/DD
      MM/DD/YYYY
      YYYY/MM/DD hh:mm:ss
      MM/DD/YYYY hh:mm:ss
  */
  ;(function($){ !function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){"use strict";function b(a){if(a instanceof Date)return a;if(String(a).match(g))return String(a).match(/^[0-9]*$/)&&(a=Number(a)),String(a).match(/\-/)&&(a=String(a).replace(/\-/g,"/")),new Date(a);throw new Error("Couldn't cast `"+a+"` to a date object.")}function c(a){var b=a.toString().replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");return new RegExp(b)}function d(a){return function(b){var d=b.match(/%(-|!)?[A-Z]{1}(:[^;]+;)?/gi);if(d)for(var f=0,g=d.length;g>f;++f){var h=d[f].match(/%(-|!)?([a-zA-Z]{1})(:[^;]+;)?/),j=c(h[0]),k=h[1]||"",l=h[3]||"",m=null;h=h[2],i.hasOwnProperty(h)&&(m=i[h],m=Number(a[m])),null!==m&&("!"===k&&(m=e(l,m)),""===k&&10>m&&(m="0"+m.toString()),b=b.replace(j,m.toString()))}return b=b.replace(/%%/,"%")}}function e(a,b){var c="s",d="";return a&&(a=a.replace(/(:|;|\s)/gi,"").split(/\,/),1===a.length?c=a[0]:(d=a[0],c=a[1])),1===Math.abs(b)?d:c}var f=[],g=[],h={precision:100,elapse:!1};g.push(/^[0-9]*$/.source),g.push(/([0-9]{1,2}\/){2}[0-9]{4}( [0-9]{1,2}(:[0-9]{2}){2})?/.source),g.push(/[0-9]{4}([\/\-][0-9]{1,2}){2}( [0-9]{1,2}(:[0-9]{2}){2})?/.source),g=new RegExp(g.join("|"));var i={Y:"years",m:"months",n:"daysToMonth",w:"weeks",d:"daysToWeek",D:"totalDays",H:"hours",M:"minutes",S:"seconds"},j=function(b,c,d){this.el=b,this.$el=a(b),this.interval=null,this.offset={},this.options=a.extend({},h),this.instanceNumber=f.length,f.push(this),this.$el.data("countdown-instance",this.instanceNumber),d&&("function"==typeof d?(this.$el.on("update.countdown",d),this.$el.on("stoped.countdown",d),this.$el.on("finish.countdown",d)):this.options=a.extend({},h,d)),this.setFinalDate(c),this.start()};a.extend(j.prototype,{start:function(){null!==this.interval&&clearInterval(this.interval);var a=this;this.update(),this.interval=setInterval(function(){a.update.call(a)},this.options.precision)},stop:function(){clearInterval(this.interval),this.interval=null,this.dispatchEvent("stoped")},toggle:function(){this.interval?this.stop():this.start()},pause:function(){this.stop()},resume:function(){this.start()},remove:function(){this.stop.call(this),f[this.instanceNumber]=null,delete this.$el.data().countdownInstance},setFinalDate:function(a){this.finalDate=b(a)},update:function(){if(0===this.$el.closest("html").length)return void this.remove();var b,c=void 0!==a._data(this.el,"events"),d=new Date;b=this.finalDate.getTime()-d.getTime(),b=Math.ceil(b/1e3),b=!this.options.elapse&&0>b?0:Math.abs(b),this.totalSecsLeft!==b&&c&&(this.totalSecsLeft=b,this.elapsed=d>=this.finalDate,this.offset={seconds:this.totalSecsLeft%60,minutes:Math.floor(this.totalSecsLeft/60)%60,hours:Math.floor(this.totalSecsLeft/60/60)%24,days:Math.floor(this.totalSecsLeft/60/60/24)%7,daysToWeek:Math.floor(this.totalSecsLeft/60/60/24)%7,daysToMonth:Math.floor(this.totalSecsLeft/60/60/24%30.4368),totalDays:Math.floor(this.totalSecsLeft/60/60/24),weeks:Math.floor(this.totalSecsLeft/60/60/24/7),months:Math.floor(this.totalSecsLeft/60/60/24/30.4368),years:Math.abs(this.finalDate.getFullYear()-d.getFullYear())},this.options.elapse||0!==this.totalSecsLeft?this.dispatchEvent("update"):(this.stop(),this.dispatchEvent("finish")))},dispatchEvent:function(b){var c=a.Event(b+".countdown");c.finalDate=this.finalDate,c.elapsed=this.elapsed,c.offset=a.extend({},this.offset),c.strftime=d(this.offset),this.$el.trigger(c)}}),a.fn.countdown=function(){var b=Array.prototype.slice.call(arguments,0);return this.each(function(){var c=a(this).data("countdown-instance");if(void 0!==c){var d=f[c],e=b[0];j.prototype.hasOwnProperty(e)?d[e].apply(d,b.slice(1)):null===String(e).match(/^[$A-Z_][0-9A-Z_$]*$/i)?(d.setFinalDate.call(d,e),d.start()):a.error("Method %s does not exist on jQuery.countdown".replace(/\%s/gi,e))}else new j(this,b[0],b[1])})}}); }(jQuery) );

  ;(function( $ ){
    jQuery.fn.countdownTimer = function(options){
      return this.each(function(){
        console.log('countdownTimer function called.');
        var countdownEndDate = $(this).attr("data-countdown-end-date");
        $(this).countdown( countdownEndDate , function(event) {
          console.log('countdown function callback fired');
          $(this).find('.js-countdown-days').html( event.strftime('<span class="js-countdown-number">%D</span>') );
          $(this).find('.js-countdown-hours').html( event.strftime('<span class="js-countdown-number">%H</span>') );
          $(this).find('.js-countdown-minutes').html( event.strftime('<span class="js-countdown-number">%M</span>') );
          $(this).find('.js-countdown-seconds').html( event.strftime('<span class="js-countdown-number">%S</span>') );
        });
      });
    }
  }( jQuery ) );

  jQuery(document).ready(function($){
    $(".js-countdown-timer").countdownTimer();
  });
</script>
{% endif %}

<script type="text/javascript" justification="custom ui" src="https://dbqvwi2zcv14h.cloudfront.net/ak/donate.js"></script>

<script language="javascript">

  $(function () {
    $('input[name="amount"]').on(
      'click', highlight_selected_amount_button);
    $('input[name="amount_other"]').on(
      'click change', highlight_selected_amount_button);
    $('.ak_product_inputs').on('change blur', update_total);
    $('.ak_candidate_inputs').on('change blur', update_total);
    $('.ak-amount-radio-button')
      .on('change blur', update_total)
      .on('click', clear_other)
      .on('click', update_total);
    $('#ak-other-amount-field')
      .on('change blur', update_total)
      .on('click keypress', clear_radio_buttons)
      .on('click', update_total);

    // preselect an amount with a url parameter
    var arg_amount_selected = false;
    var arg_amount = {{ args.amount|default:"false" }};

    // Records Product "Details View" based on product click from Homepage
    dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
    dataLayer.push({
      'ecommerce': {
        'detail': {
          'actionField': {
            'list': '{{ args.source|default:"" }}',
          },
          'products': [{
            'name': 'donation',
            'id': 'id_donation',
            'variant': {% if args.amount  %} 'preset' {% else %} 'custom' {% endif %},
            'price': '{{args.amount|default:""}}',
          }]
        }
      }
    });

    var currencyCode = getCurrencyCode();
    dataLayer.push({
      event: 'view_item',
      ecommerce: {
        currency: currencyCode,
        items: [{
          item_id: '{{page.id}}',
          item_name: '{{ page.name|escapeall }}',
          quantity: 1
        }]
      }
    });

    $('.ak-amount-wrapper .input-radio-button').each(function () {
      var current_amount = parseInt($(this).text().replace(/\D/g, ''));
      if (arg_amount && (arg_amount == current_amount)) {
        clear_radio_buttons();
        $(this).trigger('click');
        arg_amount_selected = true;
      } else if (arg_amount && !arg_amount_selected) {
        if ($(this).hasClass('input-radio-button-other')) {
          clear_radio_buttons();
          $('#ak-other-amount-field').val(arg_amount).trigger('click');
        }
      } else {
        // Make sure label is highlighted if an amount is pre-selected
        highlight_selected_amount_button.call(
          $('input[name="amount"]:checked').get(0) //||
          //$('input[name="amount_other"]').get(0)
        );
      }
    });
  });

  var address_fields = [
    'address1', 'address2', 'city', 'state', 'zip'
        {% if page.allow_international %}, 'postal', 'region', 'country'{% endif %}
    ];

  {% if page.allow_international %}
  function country_change() {
    if ($('#country').val() == 'United States') {
      $('.ak-us-billing-fields').show().each(function () {
        $(this).children('input').prop('disabled', false);
      });
      $('.ak-intl-billing-fields').hide();
      $('.cards-non-us').hide();
      $('.cards-us').show();
    } else {
      $('.ak-us-billing-fields').hide();
      $('.ak-intl-billing-fields').show().each(function () {
        $(this).children('input').prop('disabled', false);
      });
      $('.cards-non-us').show();
      $('.cards-us').hide();
    }
  }
    function shipping_country_change() {
        if ( $('#shipping_country').val() == 'United States' ) {
            $('.ak-us-shipping-fields').show();
            $('.ak-intl-shipping-fields').hide();
        } else {
            $('.ak-us-shipping-fields').hide();
            $('.ak-intl-shipping-fields').show();
        }
    }
    $( function () {
        $('#country').on('change blur', country_change);
        $('#id_shipping_country').on('change blur', shipping_country_change);
        country_change();
        shipping_country_change();
    } );
    {% endif %}


  function toggle_shipping() {
    if ($('#ak-shipping-same').prop("checked")) {
      sync_to_shipping();
      $('#ak-shipping-fields').slideUp();
      if ($('.ak-shipping-required').length)
        $('.ak-shipping-required').remove();
    } else {
      clear_shipping();
      $('#ak-shipping-fields').slideDown();
      $('#ak-shipping-fields').append(
        "<input type='hidden' name='required' value='shipping_address1' class='ak-shipping-required'>");
      $('#ak-shipping-fields').append(
        "<input type='hidden' name='required' value='shipping_city' class='ak-shipping-required'>");
      $('#ak-shipping-fields').append(
        "<input type='hidden' name='required' value='shipping_state' class='ak-shipping-required'>");
      $('#ak-shipping-fields').append(
        "<input type='hidden' name='required' value='shipping_zip' class='ak-shipping-required'>");
    }
  }

  function clear_shipping(e) {
    var i, field, ship_field;
    for (i in address_fields) {
      field = address_fields[i];
      ship_field = $('#id_shipping_' + field);
      ship_field.val("").change().prop("readonly", false);
    }
    {% if page.allow_international %}
    shipping_country_change();
    {% endif %}
  }

  function sync_to_shipping(e) {
    if (!$('#ak-shipping-same').prop("checked")) {
      return;
    }
    var i, field, ship_field, bill_value;
    for (i in address_fields) {
      field = address_fields[i];
      ship_field = $('#id_shipping_' + field);
      bill_value = $('#id_' + field).val();
      ship_field.val(bill_value).change().prop("readonly", true);
    }
    {% if page.allow_international %}
    shipping_country_change();
    {% endif %}
  }

  $(function () {
    $('#ak-shipping-same').on('change', toggle_shipping);
    toggle_shipping();

    $('#id_address1, #id_address2, #id_city, #id_state, #id_zip, ' +
      '#id_region, #id_postal').on('change blur', sync_to_shipping);
  });

  // classList changes when users change currency; use to pull three-leter ISO currency code
  function getCurrencyCode(){
    var strCurrencyCode = 'USD'; // default to usd
    var objClassList = document.querySelector('#ak-amount-list').classList;
    var arrClassList = Array.from(objClassList);
    arrClassList.forEach(function(strClass){
      if(strClass.substr(0,8) == 'currency'){
        strCurrencyCode = strClass.substr(9);
      }
    });
    return strCurrencyCode;
  }

  function change_step_one_label(current_step) {
    if (current_step == "1") {
    // Records Add to Cart
      var amount_container = $('li.ak-amount-container label.ak-radio-checked');
      var amount;
      var price;
      var frequency;
      var currency = document.querySelector('li.ak-amount-container>label>span.ak-currency-sym').innerHTML;
      var button_amount = amount_container.find('span.ak-amount-button-amount').text();
      var custom_amount = document.querySelector('#ak-other-amount-field') ? document.querySelector('#ak-other-amount-field').value : null;
      if (!custom_amount) {
        amount = button_amount;
        amount_type = 'preset';
        price = button_amount;
      } else {
        amount = 'custom';
        amount_type = 'custom';
        price = custom_amount;
      }
      if ($('input[name="donation_type"][type="hidden"]').val() === 'recurring') {
        frequency = 'recurring';
      } else {
        frequency = 'single';
      }

      dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
      dataLayer.push({
        'event': 'addToCart',
        'ecommerce': {
          'add': {
            'products': [{
              'name': 'donation',
              'id': 'id_donation',
              'variant': amount_type,
              'price': price,
              'quantity': 1,
              'dimension2': frequency
            }]
          }
        }
      });

      var currencyCode = getCurrencyCode();
      dataLayer.push({
        event: 'add_to_cart',
        ecommerce: {
          currency: currencyCode,
          items: [{
            item_id: '{{page.id}}',
            item_name: '{{ page.name|escapeall }}',
            item_category: amount_type,
            item_variant: frequency, 
            quantity: 1
          }]
        }
      });
    } else if (current_step == "2") { 
      // Records Checkout Step 1
      checkout_step_track(1);
    }
    {% comment %} // change amount label if step 1 is complete
    if (current_step === "1") {
      var amount_container = $('li.ak-amount-container label.ak-radio-checked');
      var amount = document.querySelector('li.ak-amount-container>label>span.ak-currency-sym').innerHTML;
      var button_amount = amount_container.find('span.ak-amount-button-amount').text();
      var custom_amount = document.querySelector('#ak-other-amount-field')? document.querySelector('#ak-other-amount-field').value : null;
      if (!custom_amount) amount += button_amount;
      else amount += custom_amount;

      if ($('input[name="donation_type"][type="hidden"]').val() === 'recurring') {
        amount += '/mo';
      } else {
        amount.replace('/mo', '');
      }
    }

    $('input[name="ak-donate-step"]:checked')
      .closest('label')
      .find('span.ak-amount-label')
      // .html(amount+'<span class="ak-donation-monthly">/mo</span>')
      .html(amount)
      .css({ "text-decoration": "underline" }); {% endcomment %}
  }

  let step_has_errors = false;
  function three_step_advance() {

    // trigger validation on the step we're leaving
    var current_step = $('input[name="ak-donate-step"]:checked').val();
    validate_step(current_step);

    if (!step_has_errors) {
      show_tick(current_step);
      change_step_one_label(current_step);
      // check radio button in next step
      $('input[name="ak-donate-step"]:checked')
        .closest('label')
        .removeClass('active-step')
        .next('label')
        .addClass('active-step')
        .find('input[type="radio"]')
        .prop('checked', true);

      three_step_reveal();
      scroll_to_top_of_box();
    } else {
      hide_tick(current_step);
    }
  }

  /**
  * Function Step
  */

  function validate_step(step) {
    step_has_errors = false;
    if (step === "1") {
      validate_fields = ["amount"];
    } else if (step == "2") {
      validate_fields = ["email", "first_name", "last_name", "name",
        "address1", "address2", "city", "state", "zip",
        "country", "region", "postal",
        "shipping_address1", "shipping_address2",
        "shipping_city", "shipping_state",
        "shipping_zip", "shipping_country",
        "shipping_region", "shipping_postal",
        "privacy"
                           {% if templateset.custom_fields.ask_occupation_and_employer %}, "action_employer", "action_occupation"{% endif %}];
    } else {
      validate_fields = ["card_num",
        "exp_date_year", "exp_date_month", "exp_date"];
    }

    doing_step_validation = true;
    actionkit.forms.validate();
    doing_step_validation = false;

    if (step == "1") {
      step_has_errors = step_1_validation();
    }

    if (step == "2" && !step_has_errors) {
      step_has_errors = step_2_validation();
    }

    if (step == "3" && !step_has_errors) {
      step_has_errors = step_3_validation();
    }
      // What do we do with this step_has_errors
  }

  function do_validate_credit_card() {
    // Check if we need to validate the CC
    if (actionkit.donations && actionkit.donations.skip_cc_validation) {
      // Don't validate CC.
      return false;
    }
    return true;
  }

  function step_3_validation() {
    var step_has_errors = false;

    if (!valid_email($('#id_email').val())) {
      if (!actionkit.errors) actionkit.errors = {};
      actionkit.errors['email:invalid'] = actionkit.forms.errorMessage('email:invalid');
      actionkit.forms.onValidationErrors(actionkit.errors);
      step_has_errors = true;
    }

    if (!do_validate_credit_card()) {
      return step_has_errors; // Leaves this function?
    }

    if (!valid_credit_card($('#ak-card_num').val())) {
      if (!actionkit.errors) actionkit.errors = {}
      actionkit.errors['card_num:invalid'] = actionkit.forms.errorMessage('card_num:invalid');
      actionkit.forms.onValidationErrors(actionkit.errors);
      step_has_errors = true;
    }

    if (!valid_credit_card_code($('#ak-card_code').val())) {
      if (!actionkit.errors) actionkit.errors = {}
      actionkit.errors['card_code:invalid'] = actionkit.forms.errorMessage('card_code:invalid');
      actionkit.forms.onValidationErrors(actionkit.errors);
      step_has_errors = true;
    }

    return step_has_errors;
  }

  function step_2_validation() {
    var step_has_errors = false;

    if (document.getElementById("country").value === "United States" && document.getElementById("id_state").value === "") {
      if (!actionkit.errors) actionkit.errors = {};
      actionkit.errors['state:missing'] = actionkit.forms.errorMessage('state:missing');
      actionkit.forms.onValidationErrors(actionkit.errors);
      step_has_errors = true;
    }

    return step_has_errors;
  }

  function step_1_validation() {
    var step_has_errors = false;

    // look for product selections
    var selected_products = false;
    product_infos().forEach(function (info) {
      if (info.quantity) {
        selected_products = true;
      }
    });

    // look for candidate selections
    var selected_candidates = false;
    $('.ak_candidate_inputs').each(function (i) {
      if ($(this).val() != "") {
        selected_candidates = true;
      }
    });

    // there's no built-in validation for amounts, so do it here
    if (!selected_products && !selected_candidates &&
      !$('.ak-amount-radio-button').is(':checked') &&
      $('#ak-other-amount-field').val() == "") {
      if (!actionkit.errors)
        actionkit.errors = {};
      actionkit.errors['amount:missing'] = actionkit.forms.errorMessage('amount:missing');
      actionkit.forms.onValidationErrors(actionkit.errors);
      step_has_errors = true;

    } else if (($('#ak-other-amount-field').val() != "" &&
      $('#ak-other-amount-field').val() != undefined) &&
      !/^\d*(\.\d{1,2})?$/.test($('#ak-other-amount-field').val())) {
      if (!actionkit.errors)
        actionkit.errors = {};
      actionkit.errors['amount:invalid'] = actionkit.forms.errorMessage('amount:invalid');
      actionkit.forms.onValidationErrors(actionkit.errors);
      step_has_errors = true;
    }

    {% if page.minimum_amount %}
    var total = update_total();
    if (!step_has_errors && total < {{ page.minimum_amount }}) {
      if (!actionkit.errors) {
        actionkit.errors = {};
      }
      err = actionkit.forms.errorMessage('amount:minimum');
      err = err.replace("{0}", "{{ page.minimum_amount }}");
      actionkit.errors['amount:minimum'] = err;
      actionkit.forms.onValidationErrors(actionkit.errors);
      step_has_errors = true;
    }
    {% endif %}

    return step_has_errors;
    }

  {% if show_paypal or page.custom_fields.donation_only_paypal or page.custom_fields.donation_only_paypal.strip|lower == 'y' %}

  function submit_paypal() {
    {% if page.paypal_user_requirements != "none" %}
    {% if page.paypal_user_requirements == "email" %}
    validate_fields = ["email", "privacy"];
    {% else %}
    validate_fields = [
      "email", "first_name", "last_name", "name",
      "address1", "address2", "city", "state", "zip",
      "country", "region", "postal",
      "shipping_address1", "shipping_address2",
      "shipping_city", "shipping_state",
      "shipping_zip", "shipping_country",
      "shipping_region", "shipping_postal",
      "privacy"
                    {% if templateset.custom_fields.ask_occupation_and_employer %}, "action_employer", "action_occupation"{% endif %}
               ];
    {% endif %}

    doing_step_validation = true;
    actionkit.forms.validate();
    doing_step_validation = false;
    if (!$.isEmptyObject(actionkit.errors)) {
      return false;
    }
    {% endif %}

    /* set the paypal=1 hidden field */
    $('#ak-pay-by-paypal').val(1);

    /* clear out CC info if entered */
    $('#ak-card_num').val('');
    $('#ak-card_code').val('');

    /* disable CC requirements */
    $('#ak-card_num-required').remove();
    $('#ak-card_code-required').remove();
    $('#ak-exp_date_month-required').remove();
    $('#ak-exp_date_year-required').remove();

    /* and keep submitting */
    checkout_step_track(2, "paypal");
    return true;
    }

  function submit_cc() {
    /* clear paypal=1 hidden field, only needed if someone hit back */
    $('#ak-pay-by-paypal').val(0);

    if ($('form.ak-donate-three-step').length > 0) {
      validate_step("3");

      if (step_has_errors) {
        return false;
      } else {
        checkout_step_track(2, "cc");
        return true;
      }
    }

    /* not doing 3-step, so we need to do all the validation here,
     * don't want to short-circuit and only run one step, better
     * to run all three even if all three have errors */
    actionkit.forms.validate();
    results = [step_1_validation(),
    step_2_validation(),
    step_3_validation()];
    return !(results[0] || results[1] || results[2]);
  }

  function checkout_step_track(step, payment) {
    var amount_container = $('li.ak-amount-container label.ak-radio-checked');
    var amount;
    var price;
    var frequency;
    var currency = document.querySelector('li.ak-amount-container>label>span.ak-currency-sym').innerHTML;
    var button_amount = amount_container.find('span.ak-amount-button-amount').text();
    var custom_amount = document.querySelector('#ak-other-amount-field') ? document.querySelector('#ak-other-amount-field').value : null;
    if (!custom_amount) {
      amount = button_amount;
      amount_type = 'preset';
      price = button_amount;
    } else {
      amount = 'custom';
      amount_type = 'custom';
      price = custom_amount;
    }
    if ($('input[name="donation_type"][type="hidden"]').val() === 'recurring') {
      frequency = 'recurring';
    } else {
      frequency = 'single';
    }
    var country = document.getElementById("country").value;
    dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
    dataLayer.push({
      'event': 'checkout',
      'ecommerce': {
        'checkout': { // 'add' actionFieldObject measures.
          'actionField': {
          'step': step,
          'option': country,
          },
          'products': [{
            'name': 'donation',
            'id': 'id_donation',
            'variant': amount_type,
            'price': price,
            'quantity': 1,
            'dimension2': frequency,
            'donationFrequency': frequency
          }]
        }
      }
    });

    var currencyCode = getCurrencyCode();
    dataLayer.push({
      event: 'begin_checkout',
      ecommerce: {
        currency: currencyCode,
        value: price,
        items: [{
          item_id: '{{page.id}}',
          item_name: '{{ page.name|escapeall }}',
          item_category: frequency,
          item_variant: amount_type,
          quantity: 1
        }]
      }
    });
  }

  // Tab Creation Code
  $(function () {
    const CONSTANTS = {
      ACTIVE_PAYMENTS_CLASS: "payments-title-active",
      PAYPAL_TARGET_CLASS: "paypal-title"
    };

    const paypalButton = $('#ak-paypal-button');
    // Initially hide the ^^ button
    paypalButton.css({ display: 'none' });

    const paymentsTitles = $(".payments-title");

    // Get CC & PayPal Fields
    const ccFields = $(".cc-fields");
    const paypalFields = $("paypal-fields");

    const removeActivePaymentsClass = function () {
      $.each(paymentsTitles, function (index, title) {
        const titleCtn = $(title);
        titleCtn.removeClass(CONSTANTS.ACTIVE_PAYMENTS_CLASS);
        paypalFieldSelectedStepThree = false;
        ccFieldsSelectedStepThree = true;
      });
    };

    // Use this to hide fields as appropriately
    const toggleShowFields = function (fields, show) {
      $.each(fields, function (index, field) {
        const fieldCtn = $(field);
        fieldCtn.css({ 'display': show ? 'block' : 'none' });
      });
    };


    $.each(paymentsTitles, function (index, title) {
      const titleCtn = $(title);
      titleCtn.click(function (e) {
        const clicked = $(e.target);
        const parentHasClass = clicked.parents('.' + CONSTANTS.ACTIVE_PAYMENTS_CLASS).length > 0;
        if (parentHasClass) return;
        else {
          const closestDiv = clicked.closest('.payments-title');

          if (closestDiv.hasClass(CONSTANTS.PAYPAL_TARGET_CLASS)) {
            toggleShowFields(paypalFields, true);
            toggleShowFields(ccFields, false);
            paypalFieldOptionSelectedStepThree = true;
            paypalButton.css({ display: 'inline-block' });
          } else {
            toggleShowFields(ccFields, true);
            toggleShowFields(paypalFields, false);
            paypalFieldOptionSelectedStepThree = false;
            paypalButton.css({ display: 'none' });

          }
          removeActivePaymentsClass();
          closestDiv.addClass(CONSTANTS.ACTIVE_PAYMENTS_CLASS);
          return;
        }

        if (clicked.hasClass(CONSTANTS.ACTIVE_PAYMENTS_CLASS)) return;
        // removeActivePaymentsClass()
        clicked.addClass(CONSTANTS.ACTIVE_PAYMENTS_CLASS);

        // Update Content
        if (clicked.hasClass(CONSTANTS.PAYPAL_TARGET_CLASS)) {
          toggleShowFields(paypalFields, true);
          toggleShowFields(ccFields, false);
          paypalFieldOptionSelectedStepThree = true;
          paypalButton.css({ display: 'inline-block' });
        } else {
          paypalFieldOptionSelectedStepThree = false;
          toggleShowFields(ccFields, true);
          toggleShowFields(paypalFields, false);
          paypalButton.css({ display: 'none' });

        }
      });
    })

    {% if page.custom_fields.donation_only_paypal or page.custom_fields.donation_only_paypal.strip|lower == 'y' %}
    toggleShowFields(paypalFields, true);
    toggleShowFields(ccFields, false);
    paypalFieldOptionSelectedStepThree = true;
    paypalButton.css({ display: 'inline-block' });

    {% endif %}
  });
  // Tab Creation Code End

  $(function () {
    $('#ak-paypal-button').on('click', submit_paypal);
    $('.ak-submit-button').on('click', submit_cc);

    {% if page.paypal_user_requirements == "none" %}
    $('#ak-paypal-button').on('mousedown', function () {
      var form_elt = $(this).closest('form');
      var required_fields = form_elt.find('input[name="required"]');
      if (required_fields.length) {
        required_fields.remove();
        $('body').on('mouseup', function (event) {
          form_elt.append(required_fields);
          $(this).unbind(event);
        });
      }
    });
    {% endif %}
  });
  {% endif %}

	{% if page.custom_fields.after_action_next_step == "flow" %}
    $(function () {
      $('.ak-submit-button').on('click', function(e) {
        if (typeof gtag !== 'undefined') {
          // send google analytics event
          gtag('event', 'scrolling-signup', {'click_id': 'thanksflow_donate_step3_submit'});
        }
      });
      $('.ak-amount-radio-button').on('click', function(e) {
        if (typeof gtag !== 'undefined') {
          var currencyValue = $('#ak-currency-switcher').val();
          var currency = getCurrencyCode();
          var amount = e.target.value;
          // send google analytics event
          gtag('event', 'scrolling-signup', {'click_id': `thanksflow_step1_donate_yes_${amount}_${currency}`});
        }
      });

      $('#ak-other-amount-container').on('click', function() {
        if (typeof gtag !== 'undefined') {
          var currencyValue = $('#ak-currency-switcher').val();
          var currency = getCurrencyCode();
          // send google analytics event
          gtag('event', 'scrolling-signup', {'click_id': `thanksflow_step1_donate_yes_other_${currency}`});
        }
      });
    });
  {% endif %}

</script>

{% with page.payment_processor_information as pp %}
{% if pp.use_vzero %}
<style type="text/css">
  .hosted-field {
    height: 67px;
    padding: 0px 7px;
    padding-top: 2em;
    padding-bottom: 0.7em;
  }

  .hosted-field.braintree-hosted-fields-invalid {
    border-color: {
        {
        templateset.custom_fields.color_error
      }
    }

    ;
    background: #fff0d4;
  }

  #ak-fieldbox-card_code {
    min-height: inherit;
  }

  #ak-fieldbox-card_code {
    margin: 0;
    min-height: inherit;
    width: auto;
    margin-bottom: 20px;
  }

  .button {
    margin-top: 20px;
  }

  @media screen and (min-width:720px) {
    #ak-fieldbox-card_code {
      margin: 0px 0 0 3%;
      width: 49%;
    }
  }
</style>
{% braintree_js_libs %}
<script src="/resources/ak_braintree_vzero.js"></script>
<script>
  $(function () {
    {% if not page.custom_fields.donation_only_paypal or page.custom_fields.donation_only_paypal.strip|lower != 'y' %}
    var form = document.querySelector("#act"),
      options = {
        form: form,
        fields: {
          number: {
            selector: '#ak-card_num-hosted'
          },
          cvv: {
            selector: '#ak-card_code-hosted'
          },
          expirationDate: {
            selector: '#ak-exp_date-hosted',
            placeholder: 'MM / YYYY'
          }
        },
        styles: {
          'input': {
            'font-family': '{{ templateset.custom_fields.font_family|default:"sans-serif"|safe }}',
            'font-size': '1.1rem',
            'font-weight': 'bold',
            'color': '#17292e',
            'padding': '0.6em'
          },
          'input.invalid': {
            'color': '{{templateset.custom_fields.color_error }}',
            'background-color': '#fff0d4'
          },
          'input.valid': {
          }
        },
        submitOnEmpty: function () {
          return $('#ak-pay-by-paypal').val() == 1;
        },
        submit: form.querySelector(".ak-submit-button")
      },
      toRemove = ["#ak-card_num", "#ak-card_code", "#ak-exp_date_month",
        "#ak-exp_date_year", "#ak-card_num-required",
        "#ak-exp_date_month-required",
        "#ak-exp_date_year-required", "#ak-card_code-required"];
    toRemove.forEach(function (el) {
      $(el).remove();
    });

    // Fix to stop donation errors gettin redirected from the error page
    actionkit.utils.appendHiddenInput('referer_from_url', '1');
    actionkit.donations.handleError = function (err) {
      if (window.console) {
        window.console.log(err);
      }
      if (!actionkit.errors) {
        actionkit.errors = {};
      }
      switch (err.code) {
        case 'HOSTED_FIELDS_FIELDS_EMPTY':
          actionkit.errors['card_num:invalid'] = "Credit card fields are empty.";
          break;
        case 'HOSTED_FIELDS_FIELDS_INVALID':
          err.details.invalidFieldKeys.forEach(function (key) {
            var map = {
              'number': 'card_num',
              'cvv': 'card_code',
              'expirationDate': 'card_exp'
            };
            actionkit.errors[map[key] + ':invalid'] = "This field is invalid.";;
          });
          break;
        case 'HOSTED_FIELDS_FAILED_TOKENIZATION':
          actionkit.errors['card_num:invalid'] = "Please check that your credit card is valid.";
          break;
        case 'HOSTED_FIELDS_TOKENIZATION_NETWORK_ERROR':
          actionkit.errors['card_num:invalid'] = "Network error.";
          break;
        default:
          actionkit.errors['card_num:invalid'] = "An error occurred: " + err.message;
      }
      actionkit.forms.onValidationErrors(actionkit.errors);
    };
    actionkit.donations.initClient('{{ pp.client_token }}', options);
    // read by 3-step validation
    actionkit.donations.skip_cc_validation = true;
    actionkit.donations.vzero = true;
    $(".hosted-field.braintree-hosted-fields-invalid").prev().css("background-color", "#fff0d4");
    {% endif %}
  });
</script>
{% endif %}
{% endwith %}

{% if page.custom_fields.donate_payment_frequency_above_amounts.strip|lower == 'y' %}
<script>
  $(function () {
    $('#ak-recurring-type').insertBefore('#ak-amount-list');
    $('#ak-recurring-type').addClass('paymenttype-above');
  });
</script>
{% endif %}

<style>
  .name-container fieldset {
    display: inline-flex;
  }

  .first-name-container, .last-name-container {
    flex: 1;
  }

  .first-name-container {
    border-right: solid 1px rgba(21, 36, 43, 0.3) !important;
  }

  .last-name-container {
    border-top: 0 !important;
  }
</style>

<!-- New styles for more accessible donate pages -->
{% if page.custom_fields.after_action_next_step != "flow" and page.custom_fields.page_background_color in "new_accessible,new_accessible_desktop,blue_opaque,white_opaque,dkgray_opaque"|split:"," %}
  <style>
    #body-mobile-background {
      opacity: 1;
    }

    #action-lead .section-inner {
      background-color: #0E76D8;
      border-radius: 2px;
      padding: 0px 15px;
    }
    .bg-blue-fade {
      background-color: transparent !important;
    }

    #action-header {
      margin-top: 1.25rem;
    }

    #action-lead {
      padding: 2vh 4vw;
    }

    @media screen and (min-width:720px) {
      .bg-blue-fade {
        background-image: unset !important;
      }

      #action-header {
        margin-top: 0;
      }

      #action-lead {
        padding: 9vh 7.5vw;
      }
      #action-lead .section-inner {
        padding: 75px 50px;
      }
    }
    #action-lead .section-inner,  #action-lead .section-inner a,
    #donation-other .section-inner, #donation-other .section-inner a,
    #site-footer .section-inner, #site-footer .section-inner a {
      color: white;
    }

    @media screen and (min-width:720px) {
      #action-lead .section-inner {
        padding: 75px 50px;
      }
    }

    #donation-other, #site-footer {
      background-color: #0E76D8;
      padding: 0;
    }

    #donation-other .section-inner, #site-footer .section-inner {
      padding: 50px;
    }
  </style>
{% endif %}

{% if page.custom_fields.page_background_color == 'new_accessible_desktop' %}
  <style>
    #body-mobile-background {
      background-image: unset;
      background-color: #0E76D8;
    }

    @media screen and (min-width:720px) {
			#body-mobile-background {
				background-image: url({{ page.custom_fields.page_background_image }});
			}
    }
  </style>  
{% endif %}

{% if page.custom_fields.donate_enable_countdown and page.custom_fields.donate_countdown_date and page.custom_fields.donate_countdown_copy %}
<style>
  .countdown {
    background-color: #FFA902;
    height: 67px;
    position: relative;
    width: 100%;
    padding: 12px;
    max-width: 550px;
    display: flex;
    flex-direction: row;
    align-items: center;
  }

  @media screen and (min-width:900px) {
    .countdown {
      max-width: 900px;
      padding: 20px;
    }
  }
  
  @media screen and (min-width:720px) {
    #action-lead .section-inner {
      padding: 0px;
    }

    form {
      padding: 20px;
      padding-top: 1.5em;
    }
  }

  @media screen and (max-width: 720px) {
    #action-lead {
      padding: 0;
    }
    #action-lead .section-inner {
      padding: 2vh 4vw;
    }

    .title-section-60, .title-section {
      justify-content: unset;
    }
  }

</style>
{% endif %}
<script>
  jQuery(document).ready(function($){
    const searchParams = new URLSearchParams(window.location.search);

    {% if page.custom_fields.after_action_next_step == "flow" %}
    var firstName = '{{ user.first_name }}';
    var lastName = '{{ user.last_name }}';
    var emailAddress = '{{ user.email }}';
    var city = '{{ user.city }}';
    var actionID = searchParams.get('action_id');
    var akid = searchParams.get('akid');
    var origPageName = searchParams.get('og_page_name');
    var origBgImage = '{{ action.custom_fields.original_bgimage }}';

    if (origBgImage) {
      $('#action_original_bgimage').val(origBgImage);
    }

    if (firstName) {
      $('.actionFirstName').text(firstName);
    }
    $('#id_first_name').val(firstName);
    $('#id_last_name').val(lastName);
    $('#id_email').val(emailAddress);
    $('#action_original_actionid').val(actionID);
    $('#action_original_page_name').val(origPageName);
    $('#id_city').val(city);

    $('#ak-continue-button').on('click', function() {
      var currentStep = parseInt($('.donate-lead input[name="ak-donate-step"]:checked').val()) - 1;
      if (typeof gtag !== 'undefined') {
        // send google analytics event
        gtag('event', 'scrolling-signup', {'click_id': `thanksflow_donate_step${currentStep}_continue`});
      }
      if ($('.ak-donate-area-step-1').is(':visible')) {
        $('#action-title').show();
        $('#action-description').show();
      } else {
        $('#action-pretitle').show();
      }
      if ($('.ak-donate-area-step-2').is(':visible')) {
        $('#action-title').hide();
        $('#action-description').hide();
      }
      if ($('.ak-donate-area-step-3').is(':visible')) {
        $('#action-title').hide();
        $('#action-description').hide();
      }
    });

    $('.ak-donate-step').on('click', function() {
      if ($('.ak-donate-area-step-1').is(':visible')) {
        $('#action-title').show();
        $('#action-description').show();
      } else {
        $('#action-pretitle').show();
      }
      if ($('.ak-donate-area-step-2').is(':visible')) {
        $('#action-title').hide();
        $('#action-description').hide();
      }
      if ($('.ak-donate-area-step-3').is(':visible')) {
        $('#action-title').hide();
        $('#action-description').hide();
      }
    });

    $('.cant-donate').on('click', function() {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'scrolling-signup', {'click_id': 'thanksflow_step1__donate_no'});
      }
      var currentPageName = '{{ page.name }}';
      var currentQueryParams = window.location.search;
      window.location.href = `/cms/thanks/${currentPageName}/?og_page_name=${origPageName}&source=post-donation-share&action_id=${actionID}&firstName=${firstName}&origBgImage=${origBgImage}`;
    });

    const step3Div = document.querySelector('.ak-donate-area-step-3.form-style-labelabove');
    const observer = new MutationObserver(() => {
      if ($('.ak-donate-area-step-3').is(':visible')) {
        $('.cant-donate-container').hide();
      } else {
        $('.cant-donate-container').show();
      }
    });

    observer.observe(step3Div, {
      attributes: true,
      attributeFilter: ['style', 'class']
    });

    {% endif %}

    if (searchParams.has('skip2') && searchParams.get('skip2') === 'true') {
      three_step_advance();
    }

    $('#ak-currency-switcher').on('change', function() {
      var currencyVal = $(this).val();
      if (currencyVal === 'Braintree Client-Side Encryption ZAR') {
        $('.paypal-title').hide();
      } else {
        $('.paypal-title').show();
      }
    });

  });
</script>

{% endblock %}
