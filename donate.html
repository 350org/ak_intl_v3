{% extends "./wrapper.html" %}
{% load actionkit_tags %}

{% block content %}

<section id="action-lead" class="section donate-lead action-lead title-section width-medium padding-medium bg-{% if page.custom_fields.page_background_color %}{{ page.custom_fields.page_background_color }}{% else %}white{% endif %}{% if page.custom_fields.page_background_image %}-fade{% endif %}">
	<div class="section-inner">
		<form id="act" name="act" class="{% if page.payfment_processor_information.use_tr %}braintree_form{% endif %} {{ templateset.custom_fields.donation_steps }} " method="POST" action="/act/" accept-charset="utf-8">
      <a id="jump-to-form" href="#donate" class="tablet-hide desktop-hide mobile-hide bg-orange text-underline-none text-center arrow-down text-large2">{% if page.custom_fields.form_submit_button_text %}{{ page.custom_fields.form_submit_button_text }}{% else %}{% filter ak_text:"donate_submit_button" %}Donate{% endfilter %}{% endif %}</a>
  		<input type="hidden" name="page" value="{{ page.name }}">
  		<input type="hidden" name="orig_akid" value="{{ akid }}">
			<div id="action-header" class="{% if page.custom_fields.page_layout_style == 'expanded' %}c10{% else %}c5{% endif %} ct10 cm10 c-wide">
{% if page.custom_fields.page_pretitle %}
			<p id="action-pretitle" class="text-font-secondary"><span class="highlight bg-dkgray-trans">{{ page.custom_fields.page_pretitle }}</span></p>
{% endif %}
			<h2 id="action-title" class="title3">
{% if page.custom_fields.page_title_custom_html %}
	{% autoescape off %}{{ page.custom_fields.page_title_custom_html }}{% endautoescape %}
{% else %}
				<span class="{{ page.custom_fields.page_title_style }}">{{ page.title }}</span>
{% endif %}
			</h2>
{% if page.custom_fields.page_author %}
			<div class="action-author" class="margin-bottom-normal">
				{% if page.custom_fields.page_author_image %}<span class="action-author-image"><img src="{{ page.custom_fields.page_author_image }}"></span> {% else %}&mdash; {% endif %}<span class="action-author-text meta">{% autoescape off %}{{ page.custom_fields.page_author }}{% endautoescape %}</span>
			</div>
{% endif %}

{% comment %}If "layout" is set to "expanded", end the full-width title <div> and start a half-width description <div>.{% endcomment %}
{% if page.custom_fields.page_layout_style == 'expanded' %}
	</div>
{% endif %}

	<div id="action-description" class="{% if page.custom_fields.page_layout_style == 'expanded' %}c5 ct10 cm10{% endif %} text-large margin-top-none margin-bottom-huge">
{% if page.custom_fields.featured_image %}
		<img class="ak-featured-img" src="{{ page.custom_fields.featured_image }}">
{% endif %}
		<div {% if page.custom_fields.page_layout_style == "expanded" %}{% else %}data-read-more-after="{% if page.custom_fields.page_description_readmore %}{{ page.custom_fields.page_description_readmore }}{% else %}2{% endif %}"{% endif %}>
			{% include_tmpl form.ask_text %}
		</div>
	</div>

{% comment %}If "layout" is *not* set to "expanded", end the title <div> here, after the description <div>.{% endcomment %}
{% if page.custom_fields.page_layout_style != 'expanded' %}
			</div>
{% endif %}


{% comment %}The ID "donate" here breaks from normal naming convention so that there's a cleaner appearance when using it for anchor linking directly to the form.{% endcomment %}
  <div id="donate" class="action-form c5 ct10 cm10 c-wide margin-top-none">
    <div class="ak-field-box ak-donate-three-step">
{% autoescape off %}
	{% if page.custom_fields.form_text_above_form %}
		<div id="form-intro" class="p text-large text-lineheight-small strong">
			{{ page.custom_fields.form_text_above_form }}
		</div>
	{% endif %}
{% endautoescape %}
		{% include "./progress_meter.html" %}
    <!--Add .ak-donate-three-step for three-step-->
    <div class="ak-donate-menu ak-donate-three-step ak-donate-three-step-visible text-center margin-bottom-none box text-small bg-white-trans">
        <label class="ak-donate-step ak-donate-step-1 active-step" for="ak-donate-step-1">
            <span class="ak-step-number strong inline-dot bg-dkgray-trans">1</span>&nbsp;<span>{% filter ak_text:"donate_step_1_amount" %}Amount{% endfilter %}</span>
            <input type="radio" id="ak-donate-step-1" class="hidden" name="ak-donate-step" value="1" checked="checked">
        </label>
        <label class="ak-donate-step ak-donate-step-2" for="ak-donate-step-2">
            <span class="ak-step-number strong inline-dot bg-dkgray-trans">2</span>&nbsp;<span>{% filter ak_text:"donate_step_2_info" %}Info{% endfilter %}</span>
            <input type="radio" id="ak-donate-step-2" class="hidden" name="ak-donate-step" value="2">
        </label>
        <label class="ak-donate-step ak-donate-step-3" for="ak-donate-step-3">
            <span class="ak-step-number strong inline-dot bg-dkgray-trans">3</span>&nbsp;<span>{% filter ak_text:"donate_step_3_payment" %}Payment{% endfilter %}</span>
            <input type="radio" id="ak-donate-step-3" class="hidden" name="ak-donate-step" value="3">
        </label>
    </div>

    <div id="ak-donation-details" class="box box-medium bg-white">
      <div id="ak-product-list" class="ak-donate-area-step-1 ak-errs-below">
{% if has_products %}
          <table class="ak-margin-bottom-1">
            <thead>
	            <tr>
	              <th class="ak-product-details-header ak-small-header">Product</th>
	              <th class="ak-product-amount-header ak-small-header">Price</th>
	              <th class="ak-product-quantity-header ak-small-header">Quantity</th>
	              <th class="ak-product-quantity-header ak-small-header">Total</th>
	            </tr>
            </thead>
            <tbody>
  {% for product in products %}
            <tr>
              <td class="ak-product-details">
                <div class="ak-product-name">{{ product.name }}</div>
    {% if product.desc %}
								<div class="ak-product-description">{{ product.desc }}</div>
		{% endif %}
              </td>
              <td class="ak-product-amount">
                <span id="product_{{ product.id }}_price" data-price="{{ product.price }}">
    {% if product.price == 0 %}
				      		FREE!
    {% else %}
                <span class="ak-currency-sym">{{ page.currency_sym }}</span>{{ product.price|commify }}
    {% endif %}
                </span>
              </td>
              <td class="ak-product-quantity">
    {% if product.max == 1 %}
                  <input type="checkbox" value="1" name="product_{{ product.id }}" id="product_{{ product.id }}" class="ak_product_inputs">
    {% else %}
                  <input type="number" min="0" max="{{ product.max }}" onvalidate="return validate_product_count(this)" name="product_{{ product.id }}" id="product_{{ product.id }}" size="2" class="ak_product_inputs">
    {% endif %}
              </td>
              <td class="ak-product-subtotal">
                  <span class="ak-currency-sym">{{ page.currency_sym }}</span><span class="ak_product_subtotal_{{ product.id }}"></span>
              </td>
            </tr>
  {% endfor %}
          </tbody>
        </table>

        <p class="ak-donation-subtotal ak-align-right">
        	<label class="ak-small-header">Product Total</label>
        	<strong><span class="ak-currency-sym">{{ page.currency_sym }}</span></strong>
          <span id="ak-donation-subtotal-amount"></span>
        </p>

{% endif %}
			</div><!--product-list-->

      <div id="ak-candidate-list" class="ak-donate-area-step-1 ak-errs-below">
{% if has_candidates %}
          <table>
						<thead>
							<tr>
								<th id="ak-candidate-details-header">Candidate</th>
								<th>&nbsp;</th>
								<th id="ak-candidate-amount-header">Donation</th>
							</tr>
						</thead>
						<tbody>
  {% for candidate in candidates %}
							<tr>
								<td class="ak-candidate-details">
    {% if candidate.portrait_url %}
    	{% autoescape off %}
									<img class="ak-candidate-portrait" alt="{{ candidate.name }}" src="{{ candidate.portrait_url }}">
      {% endautoescape %}
    {% endif %}
								</td>
								<td class="ak-candidate-name">
									<div>{{ candidate.name }}</div>
    {% autoescape off %}
  								<p>{{ candidate.desc }}</p>
    {% endautoescape %}
								</td>
								<td class="ak-candidate-amount ak-align-right">
  								<span class="ak-currency-sym">{{ page.currency_sym }}</span><input type="text" name="candidate_{{ candidate.id }}" id="candidate_{{ candidate.id }}" size="2" class="ak_candidate_inputs">
								</td>
							</tr>
  {% endfor %}
						</tbody>
					</table>
{% endif %}
				</div>

{% if has_products %}
				<h4 class="ak-donate-area-step-1">Donation (Optional)</h4>
{% endif %}
        <div id="ak-amount-list" class="ak-err-above ak-donate-area-step-1 {% for currency, account_name in page.derived.currency_accounts %}{% if forloop.first %}currency-{{ currency }}{% endif %}{% endfor %}">

{% if show_currency_select %}
					<div class="ak-currency">
				    <label>
			        <select name="currency">
  {% for code in "USD,GBP,CAD,AUD,EUR"|split:"," %}
  	{% with currency_info|get:code as currency %}
								<option value="{{code}}">{{code}} - {{currency.name}}</option>
		{% endwith %}
	{% endfor %}
		            <option value="" disabled>&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;&#x2500;</option>
	{% for code, currency in currency_info.items %}
								<option value="{{code}}">{{code}} - {{currency.name}}</option>
	{% endfor %}
			        </select>
				    </label>
					</div>

{% elif page.derived.use_account_switcher %}
					<div id="ak-multi-currency">
						<label class="text-small2 text-caps" for="amount">{% filter ak_text:"general_currency" %}Currency{% endfilter %}</label>
						<select id="ak-currency-switcher" name="payment_account" class="ak-currencies">
	{% for currency, account_name in page.derived.currency_accounts %}
							<option class="ak-currency" {% if forloop.first %}checked{% endif %} id="id_currency_{{currency}}" value="{{account_name}}">
		{% if currency == "AUD" %}   {% filter ak_text:"general_au_dollar" %}Australian Dollar (AUD $){% endfilter %}
		{% elif currency == "BRL" %} {% filter ak_text:"general_br_real" %}Brazilian Real (BRL R$){% endfilter %}
		{% elif currency == "CAD" %} {% filter ak_text:"general_ca_dollar" %}Canadian Dollar (CAD $){% endfilter %}
		{% elif currency == "EUR" %} {% filter ak_text:"general_eu_euro" %}Euro (EUR €){% endfilter %}
		{% elif currency == "GBP" %} {% filter ak_text:"general_gb_pound" %}British Pound (GBP £){% endfilter %}
		{% elif currency == "USD" %} {% filter ak_text:"general_us_dollar" %}U.S. Dollar (USD $){% endfilter %}
		{% else %}
			{{ currency }}
		{% endif %}
							</option>
	{% endfor %}
						</select>
					</div>
{% endif %}

          <div class="ak-amount-wrapper clearfix margin-bottom-small">
						<h5 class="margin-bottom-normal ak-donate-three-step-hidden">Amount:</h5>
						<ul class="ak-unstyled nobullet text-large">

{% for row in amounts|columns:1 %}
  {% for amount in row %}
    {% if amount == "other" %}
              <li id="ak-other-amount-container" class="c3_3 ct3_3 cm3_3 no-margin-bottom">
                <noscript>
									<input type="radio" value="" class="ak-amount-radio-button" name="amount">
								</noscript>
                <label for="ak-other-amount-field" class="input-radio-button input-radio-button-other bg-ltgray text-font-display text-large3 strong margin-bottom-small">
                  <span class="ak-currency-sym">{{ page.currency_sym }}</span>
									<input type="number" onkeypress="return (event.charCode == 8 || event.charCode == 0) ? null : event.charCode >= 48 && event.charCode <= 57" id="ak-other-amount-field" class="text-font-display" name="amount_other" size="3">
                </label>
              </li>
    {% else %}
              <li class="ak-amount-container c3_3 ct3_3 cm3_3 no-margin-bottom">
                <label for="id_amount_{{amount}}" class="input-radio-button bg-ltgray text-font-display text-large3 strong margin-bottom-small">
                  <span class="ak-currency-sym">{{ page.currency_sym }}</span><span class="ak-amount-button-amount">{{ amount|commify }}</span>
									<input type="radio" id="id_amount_{{amount}}" value="{{ amount }}" class="ak-amount-radio-button hidden" name="amount" {% if not args.amount_other and amount == default_amount %}checked{% endif %}>
                </label>
              </li>
    {% endif %}
  {% endfor %}
{% endfor %}
						</ul>
          </div>
        </div>

        <div id="ak-donation-total-div"></div>
      	<script type="text/ak-template" for="ak-donation-total-div">
          [% if (has_products || has_candidates) { %]
            <p class="ak-donation-total ak-donate-area-step-1">
              <label for="amount">Total Amount</label>
              <span class="ak-currency-sym">{{ page.currency_sym }}</span><span class="ak-donation-total-amount"></span>
            </p>
          [% }
          	setTimeout(update_total, 0);
          %]
      	</script>

{% if not has_products %}
  {% if allow_monthly %}
    {% if page.custom_fields.donation_once_recurring_or_both|lower == "recurring" %}
      	<div id="ak-recurring-type"></div>
        <input type="hidden" name="donation_type" value="recurring">
    {% elif page.custom_fields.donation_once_recurring_or_both|lower == "once" %}
        <div id="ak-recurring-type"></div>
        <input type="hidden" name="donation_type" value="single">
        {% else %}
        <div id="ak-recurring-type" class="ak-donate-area-step-1 margin-bottom-small form-style-labelabove">
          <div class="input-checkbox text-strong margin-bottom-none">
            <input type="checkbox" name="donation_type" id="id_donation_type_recurring" value="recurring"> <label for="id_donation_type_recurring" class="text-strong">{% filter ak_text:"donate_make_recurring" %}Make this a monthly donation.{% endfilter %}</label>
          </div>
        </div>
		{% endif %}
	{% else %}
	      <div id="ak-recurring-type"></div>
	      <input type="hidden" name="donation_type" value="single">
  {% endif %}
{% endif %}

{% if page.custom_fields.donation_show_inhonorof|lower == "show" %}
        <fieldset id="in-honor-of" class="ak-donate-area-step-1 form-style-labelabove">
          <div class="input checkbox input-checkbox margin-top-none text-strong">
            <input type="checkbox" value="1" name="inhonorcheck" id="in-honor-check" />
            <label for="in-honor-check">{% filter ak_text:"donate_inhonorof_option_label" %}Donate in someone's honor.{% endfilter %}</label>
          </div>
          <div id="in-honor-of-fields" class="margin-bottom-normal">
            <div class="input text input-text ak-">
              <label for="action_in_honor_of_name">{% filter ak_text:"donate_inhonorof_name_label" %}Honoree's Name{% endfilter %}</label>
              <input type="text" id="action_in_honor_of_name" name="action_in_honor_of_name" />
            </div>
            <div class="input input-text" title="The email address to send a notification of the donation to.">
              <label for="action_in_honor_of_email">{% filter ak_text:"donate_inhonorof_email_label" %}Honoree's Email Address{% endfilter %}</label>
              <input type="text" id="action_in_honor_of_email" name="action_in_honor_of_email" />
            </div>
            <div class="input input-textarea" title="An optional note to the honoree.">
              <label for="action_in_honor_of_note" title="An optional note to the honoree.">{% filter ak_text:"donate_inhonorof_note_label" %}Note to Honoree{% endfilter %}</label>
              <textarea id="action_in_honor_of_note" name="action_in_honor_of_note" title="An optional note to the honoree." ></textarea>
            </div>
            <p class="form-instructions text-small">{% filter ak_text:"donate_inhonorof_email_note" %}We'll send a notification of your donation to this email address.{% endfilter %}</p>
          </div>
          <script>
            jQuery("#in-honor-of-fields").hide();
            jQuery("#in-honor-check").change(function(){
                if ( $(this).is(':checked') ) {
                    jQuery("#in-honor-of-fields").fadeIn();
                } else {
                    jQuery("#in-honor-of-fields").fadeOut();
                }
            });
          </script>
      </fieldset>
{% endif %}


      <div id="ak-donation-contact" class="ak-donate-area-step-2 ak-err-below form-style-labelabove">
        <ul id="ak-errors"></ul>
        <div style="display: none"><div id="known_user">
            Not <span id="known_user_name"></span>?  <a href="?" onclick="return actionkit.forms.logOut()">Click here.</a>
        </div></div>
        <div id="unknown_user"></div>
        <h5 class="margin-bottom-normal">{% filter ak_text:"donate_billing_information" %}Billing Information{% endfilter %}</h5>
        <div class="">
          {% if has_shippable_products %}
          <div class="input-text ak-input-type-user">
            <label for="id_address1">Billing address line 1</label>
            <input id="id_address1" class="" type="text" name="address1">
          </div>
          <div class="input-text ak-input-type-user">
            <label for="id_address2">Billing address line 2 (optional)</label>
            <input id="id_address2" class="" type="text" name="address2">
          </div>
          {% else %}
          <div class="input-text ak-input-type-user">
            <label for="id_address1">{% filter ak_text:"field_billing_address" %}Billing address{% endfilter %}</label>
            <input id="id_address1" class="" type="text" name="address1">
          </div>
          {% endif %}
          <div class="input-text ak-input-type-user">
            <label for="id_city">{% filter ak_text:"field_city" %}City{% endfilter %}</label>
            <input id="id_city" type="text" name="city">
          </div>
					<div>
						<div class="ak-us-billing-fields input-text ak-input-type-user">
							<input type="hidden" name="required" value="zip">
							<label for="id_zip">{% filter ak_text:"field_zip" %}Zip{% endfilter %}</label>
							<input id="id_zip" type="text" name="zip" maxlength="5" size="5">
						</div>
						<div class="ak-us-billing-fields input-select ak-input-type-user">
							<input type="hidden" name="required" value="state">
							<label for="id_state">{% filter ak_text:"field_state" %}State{% endfilter %}</label>
							{% include "./state_select.html" %}
						</div>
					</div>
{% if page.allow_international %}
					<div>
						<div class="input-text ak-input-type-user ak-intl-billing-fields">
							<label for="id_postal">{% filter ak_text:"field_postal" %}Postal Code{% endfilter %}</label>
							<input id="id_postal" type="text" name="postal" size="10">
						</div>
							<div class="input-text ak-input-type-user ak-intl-billing-fields">
								<label for="id_region">{% filter ak_text:"field_region" %}Region{% endfilter %}</label>
								<input id="id_region" type="text" name="region" size="20">
							</div>
						</div>
            <div class="input-select input-country ak-input-type-user">
              <label for="country">{% filter ak_text:"field_country" %}Country{% endfilter %}</label>
              {% include "./country_select.html" %}
            </div>
{% else %}
    				<input type="hidden" name="country" value="United States">
{% endif %}
						<div class="input-text ak-input-type-user">
							<label class="required" for="id_email">{% filter ak_text:"field_email" %}Email{% endfilter %}</label>
							<input id="id_email" class="" type="text" name="email">
						</div>
          </div>
					{% include "./privacy.html" %}

{% if has_candidates %}
          <p class="ak-label-above" id="ak-occ-emp-why">
              For political donations, we're required to ask for your employer and occupation:
          </p>
					<div class="ak-errs-below">
            <div class="input-text ak-input-type-action">
              <label for="action_employer">Employer</label>
              <input id="action_employer" class="" type="text" name="action_employer" size="20">
              <input type="hidden" name="required" value="action_employer">
            </div>
            <div class="input-text ak-input-type-action">
              <label for="action_occupation">Occupation</label>
              <input id="action_occupation" type="text" name="action_occupation" size="20">
              <input type="hidden" name="required" value="action_occupation">
            </div>
          </div>
{% endif %}

{% if has_shippable_products %}
					<div id="ak-shipping-address">
						<h4>Shipping Address</h4>
  {% with "shipping_" as input_name_prefix %}
						<div class="ak-margin-1 input-checkbox">
              <label for="ak-shipping-same" class="ak-small">
                <input id="ak-shipping-same" type="checkbox" name="shipping_same" value="1" checked>
                Ship to billing address
              </label>
            </div>
            <div id="ak-shipping-fields" class="ak-errs-below" style="display: none">
              <div class="input-text">
                <label for="id_shipping_address1">Shipping address line 1</label>
                <input id="id_shipping_address1" class="ak-input-type-action" type="text" name="shipping_address1">
              </div>
              <div class="input-text">
                <label for="id_shipping_address2">Shipping address line 2 (optional)</label>
                <input id="id_shipping_address2" class="ak-input-type-action" type="text" name="shipping_address2">
              </div>
              <div class="input-text">
                <label for="id_shipping_city">Shipping city</label>
                <input id="id_shipping_city" class="ak-input-type-action" type="text" name="shipping_city">
              </div>
              <div class="ak-us-shipping-fields">
                <div class="input-select">
                  <label for="id_shipping_state">Shipping state</label>
                  {% include "./state_select.html" %}
                </div>
              	<div class="input-text">
                  <label for="id_shipping_zip">Shipping ZIP</label>
                  <input id="id_shipping_zip" class="ak-input-type-action" type="text" name="shipping_zip" maxlength="5" size="5">
                </div>
              </div>
		{% if page.allow_international %}
              <div class="ak-intl-shipping-fields">
                <div class="input-text ak-input-type-action">
                  <label for="id_shipping_region">Shipping region</label>
                  <input id="id_shipping_region" class="ak-input-type-action" type="text" name="shipping_region" size="20">
                </div>
                <div class="input-text ak-input-type-action">
                  <label for="id_shipping_postal">Shipping postal Code</label>
                  <input id="id_shipping_postal" type="text" name="shipping_postal" size="10">
                </div>
              </div>
              <div class="input-select input-country">
                <label for="id_shipping_country">Shipping country</label>
                {% include "./country_select.html" %}
              </div>
    {% endif %}
            </div>
  {% endwith %}
        	</div> <!-- shipping address -->
{% endif %}
				</div> <!-- donation contact -->

        <div class="ak-donate-area-step-3 form-style-labelabove ak-errs-below">
					<h5 class="margin-bottom-normal">{% filter ak_text:"donate_payment_information" %}Payment Information{% endfilter %}</h5>
					<div class="input-text ak-input-type-user">
						<label for="id_name">{% filter ak_text:"field_name" %}Name{% endfilter %}</label>
						<input id="id_name" class="ak-input-type-user" type="text" name="name">
					</div>
          <div id="ak-fieldbox-card_num" class="input-text ak-input-type-user">
				    <label for="ak-card_num">{% filter ak_text:"field_card_num" %}Credit Card #{% endfilter %}</label>
				    <input type="hidden" name="required" value="card_num" id="ak-card_num-required">
				    <div id="ak-card_num-hosted" class="hosted-field"></div>
				    <input id="ak-card_num" type="text" name="card_num">
					</div>

					<div class="ak-err-below">
						<div id="ak-fieldbox-exp_date" class="input-select input-cc-expiration ak-input-type-user c5 ct5 margin-top-none">
			        <input type="hidden" name="required" value="exp_date_month" id="ak-exp_date_month-required">
			        <label for="ak-exp_date_month">{% filter ak_text:"field_exp_date" %}Expiration Date{% endfilter %}</label>
			        <div id="ak-exp_date-hosted" class="hosted-field"></div>
			        <select id="ak-exp_date_month" class="input-cc-expiration-month c4 ct4 cm4 no-margin" type="text" name="exp_date_month">
		            <option value="">MM</option>
		            <option value="01">01</option>
		            <option value="02">02</option>
		            <option value="03">03</option>
		            <option value="04">04</option>
		            <option value="05">05</option>
		            <option value="06">06</option>
		            <option value="07">07</option>
		            <option value="08">08</option>
		            <option value="09">09</option>
		            <option value="10">10</option>
		            <option value="11">11</option>
		            <option value="12">12</option>
							</select>
			        <input type="hidden" name="required" value="exp_date_year" id="ak-exp_date_year-required">
			        <select id="ak-exp_date_year" type="text" class="input-cc-expiration-year c6 ct6 cm6 no-margin" name="exp_date_year">
		            <option value="">YYYY</option>
{% for year in exp_years %}
		            <option value="{{ year.two }}">{{ year.four }}</option>
{% endfor %}
			        </select>
							<div class="clear"></div>
						</div>
				    <div id="ak-fieldbox-card_code" class="input-text input-cvv ak-input-type-user c5 ct5 margin-top-none">
			        <input type="hidden" name="required" value="card_code" id="ak-card_code-required">
			        <label for="ak-card_code" title="The 3–4 digit security code on the back of your card.">{% filter ak_text:"field_card_code" %}CVV{% endfilter %}</label>
			        <div id="ak-card_code-hosted" class="hosted-field"></div>
			        <input id="ak-card_code" type="text" name="card_code" size="4">
				    </div>
				    <div class="clear"></div>
					</div>
        </div><!--ak-styled-fields-->

{% autoescape off %}
	{% if page.custom_fields.form_additional_fields %}
				<div class="addl-html">
		{{ page.custom_fields.form_additional_fields }}
				</div>
	{% endif %}
{% endautoescape %}

				<div class="text-center">
	        <button class="ak-styled-submit-button button ak-donate-three-step-visible" id="ak-continue-button">{% filter ak_text:"donate_button_continue" %}Continue &rarr;{% endfilter %}</button>
{% if page.payment_processor_information.use_cse %}
  {% comment %}
  For pages that use CSE, the submit button will be enabled by javascript above.
  {% endcomment %}
	        <button disabled="true" type="submit" class="ak-submit-button button ak-donate-area-step-3 margin-bottom-normal">{% if page.custom_fields.form_submit_button_text %}{{ page.custom_fields.form_submit_button_text }}{% else %}{% filter ak_text:"donate_submit_button" %}Donate{% endfilter %}{% endif %} <span class="ak-currency-sym">{{ page.currency_sym }}</span><span class="ak-donation-total-amount"></span></button>
	        <noscript>
	          <p><b>JavaScript is required</b> so this page can securely submit your donation.</p>
	      	</noscript>
{% else %}
        	<button type="submit" class="ak-submit-button button ak-donate-area-step-3 margin-bottom-normal">Donate <span class="ak-currency-sym">{{ page.currency_sym }}</span><span class="ak-donation-total-amount"></span></button>
{% endif %}

{% if show_paypal %}
	        <div class="ak-payment-options text-center ak-donate-area-step-3">
	        	<input type="hidden" name="paypal" value="0" id="ak-pay-by-paypal">
						<p class="margin-bottom-small text-small"><em>{% filter ak_text:"donate_or_check_out_with" %}or check out with{% endfilter %} </em> <button type="submit" id="ak-paypal-button" class="button bg-ltgray button-small"><img src="/media/modern/paypal-logo-1.svg" style="position:relative;top:3px;"></button></p>
	        </div>
{% endif %}
				</div>
			</div>
		</div>
		<div id="action-toc" class="text-small icon-before icon-faded" data-icon="&#xE93E;">
			<strong>{% filter ak_text:"donate_secure_donation" %}Secure donation{% endfilter %}.</strong> {% if page.custom_fields.form_short_toc %}{{ page.custom_fields.form_short_toc }}{% else %}Your contribution will support 350.org groups all over the world working to build a better, climate-safe future.{% endif %}
			<span style="display:none;" class="privacy-non_eu">{% filter ak_text:"general_opt_in_privacy_notice_non_eu" %}350 will send you email updates when you can make a difference.{% endfilter %}</span>
		</div>
	</div>


		</form>
	</div>
</section>

<div id="donation-other" class="section padding-medium width-normal bg-{% if page.custom_fields.page_background_color %}{{ page.custom_fields.page_background_color }}{% else %}white{% endif %}">
	<div class="section-inner">
{% if templateset.custom_fields.donate_footer_text %}
	{% autoescape off %}
		{{ templateset.custom_fields.donate_footer_text }}
	{% endautoescape %}
{% else %}
	{% if page.custom_fields.page_is_c4 %}
		<p class="strong">Contributions or gifts to 350 Action are not deductible as charitable contributions for Federal income tax purposes.</p>
		<hr>
	{% endif %}
		<p><img style="float:right;margin:0 0 1em 1em;" src="https://s3.amazonaws.com/s3.350.org/images/RapidSSL_SEAL-90x50.gif" height="40" width="70" alt="This site is secured by RapidSSL" />
	{% filter ak_text:"donate_security" %}
			<strong class="text-small-caps">Security:</strong> This page uses <a href="https://en.wikipedia.org/wiki/HTTP_Secure" target="_blank">Secure HTTP</a> and <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank">SSL</a> technologies to make sure your information is 100% secure.
	{% endfilter %}
		</p>
	{% if page.custom_fields.page_is_c4 %}
		<p><strong class="text-small-caps">Contact Us:</strong>Questions? Problems? Please contact us at <a href="mailto:donations@350.org?subject=Question%20about%20donation%20to%20350.org">donations@350action.org</a>.</p>
		<p><strong class="text-small-caps">Update Your Account: </strong>To update your account with a new credit card, new expiration date, or new amount please visit <a href="https://350action.org/update">350action.org/update</a></p>
	{% else %}
			<div class="margin-bottom-normal">
				{% if page.payment_processor_information.currency == 'AUD' %}
				<p><strong class="text-small-caps">Donate by Cheque</strong>: Make your cheque payable to <em>350.org</em> and mail it to <em>350.org  Limited, Suite 8 / 50 Reservoir Street, Surry Hills, NSW 2010, Australia.</em>.</p>
				<p><strong class="text-small-caps">Contact Us:</strong> Questions? Problems? Please contact us at <a href="mailto:donations@350.org.au?subject=Question%20about%20donation%20to%20350.org%20Australia">donations@350.org.au</a>.</p>
				<p><strong class="text-small-caps">Update Your Account: </strong>To update your account with a new credit card, new expiration date, or new amount please visit <a href="https://350.org/update">350.org/update</a></p>
				<p>350.org Limited is a registered Australian charity but donations are NOT tax-deductible in Australia. ABN: 46 138 155 192. Some donations for joint work with our partner organisation Friends of the Earth can be made tax deductible. For information about that, please contact <a href="mailto:donations@350.org.au">donations@350.org.au</a>.</p>
				{% else %}
					{% filter ak_text:"donate_footer_text_block" %}
<p><strong class="text-small-caps">Donate by Check:</strong> Make your check payable to <em>350.org</em> and mail it to <em>350.org, 20 Jay St, Suite 732, Brooklyn, NY 11201, USA</em>.</p>
<p><strong class="text-small-caps">Other Ways To Give:</strong> <a href="https://350.org/other-ways-to-give/">Click here</a> to see additional options, including transferring stock.</p>
<p><strong class="text-small-caps">Contact Us:</strong> Questions? Problems? Please contact us at <a href="mailto:donations@350.org?subject=Question%20about%20donation%20to%20350.org">donations@350.org</a>.</p>
<p><strong class="text-small-caps">Update Your Account:</strong> To update your account with a new credit card, new expiration date, or new amount please visit <a href="https://350.org/update">350.org/update</a></p>

<div style="float:left;margin:0 1em 1em 0;"><img src="https://s3.amazonaws.com/s3.350.org/ak/charity_navigator_with_stars.png" style="float: left; height: 40px; margin-right: 10px;"> <img alt="1% For The Planet" src="https://dbqvwi2zcv14h.cloudfront.net/images/350-ak-1pftp-donate-footer.png" style="float: left; height: 40px; background: #fff; padding: 2px;"></div>

<p>350.org is a registered 501c3 non-profit organization and all contributions are tax-deductible in the United States. 350.org's EIN/Tax ID is 26-1150699. <a href="https://350.org/additional-financial-and-regulatory-information/">Additional financial information for US donors</a>.</p>
						{% endfilter %}
		{% endif %}
			</div>
	{% endif %}
{% endif %}
	</div>
</div>

{% endblock %}

{% block script_additions %}

<script language="javascript">
//<!--
    function clear_radio_buttons() {
        $('input.ak-amount-radio-button').prop('checked', false);
    }

    function clear_other() {
        $('#ak-other-amount-field').val("");
    }

    function update_total() {
        var total = 0.0;
        $('.ak_product_inputs').each(function (i) {
            // max == 1 produces checkboxes for these
            if (this.type == "checkbox" && !this.checked) {
                return;
            }

            // check that quantity is a valid int
            var quantity = this.value;
            if (quantity.length == 0 || ! /^[1-9]\d*$/.test(quantity)) {
                return;
            }

            // and price is a valid dollar amount
            var price_element = $('#' + this.id + '_price');
            var price = price_element.attr("data-price") || price_element.text();
            if (price.length == 0 || !/^[1-9]\d*(\.\d\d)?$/.test(price)) {
                return;
            }

            total += parseInt(quantity) * parseFloat(price);
        });

        $('.ak_candidate_inputs').each(function (i) {
            // check that amount is a valid amount
            var amount = this.value;
            if (amount.length == 0 || ! /^[0-9]\d*(\.\d\d)?$/.test(amount)) {
                return;
            }

            total += parseFloat(amount);
        });

        // look for checked off donation amounts
        var amount_checked = $('input:radio[name=amount]:checked').val();
        if (amount_checked) {
            total += parseFloat(amount_checked);
        } else {
            // or other amounts
            var other = $('#ak-other-amount-field').val();
            if (typeof other !== "undefined" &&
                other.length && /^\d*(\.\d{1,2})?$/.test(other))
                total += parseFloat(other);
        }

        var new_total = total == 0 ? "" : "" + total.toFixed(2);
        if (new_total != $('#total').html() ) {
            $('.ak-donation-total-amount').html(new_total);
        }
        return total;
    }


    /* Amount buttons */
    function highlight_selected_amount_button() {
        $('label.ak-radio-checked').removeClass('ak-radio-checked');
        $(this).closest('label').addClass('ak-radio-checked');
    }
		$(function() {
			$('input[name="amount"]').on(
			    'click', highlight_selected_amount_button);
			$('input[name="amount_other"]').on(
			    'click change', highlight_selected_amount_button);
			$('.ak_product_inputs').on('change blur', update_total);
			$('.ak_candidate_inputs').on('change blur', update_total);
			$('.ak-amount-radio-button')
				.on('change blur', update_total)
				.on('click', clear_other)
				.on('click', update_total);
			$('#ak-other-amount-field')
				.on('change blur', update_total)
				.on('click keypress', clear_radio_buttons)
				.on('click', update_total);

			// preselect an amount with a url parameter
			var arg_amount_selected = false;
			var arg_amount = {{ args.amount|default:"false" }};

			$('.ak-amount-wrapper .input-radio-button').each(function(){
				var current_amount = parseInt( $(this).text().replace(/\D/g,'') );
				if ( arg_amount && (arg_amount == current_amount) ){
					console.log('arg_amount == current_amount');
					clear_radio_buttons();
					$(this).trigger('click');
					arg_amount_selected = true;
				} else if (arg_amount && !arg_amount_selected){
					// console.log('arg_amount !== current_amount');
					if ( $(this).hasClass('input-radio-button-other') ){
						clear_radio_buttons();
						$('#ak-other-amount-field').val(arg_amount).trigger('click');
					}
				} else {
				  // Make sure label is highlighted if an amount is pre-selected
				  highlight_selected_amount_button.call(
				      $('input[name="amount"]:checked').get(0) //||
				      //$('input[name="amount_other"]').get(0)
				  );
				}
			});

		});

/* Currency symbols */

		actionkit.utils.currencySymbols = {
			"AUD": "AUD",
			"BRL": "R$",
			"CAD": "CAD",
			"EUR": "€",
			"GBP": "£",
			"USD": "$",
		}

    function redraw_currency_symbol() {
        var id = $('input[id^=id_currency_]:checked, option[id^=id_currency_]:selected').attr('id');
        var iso_code_match = /([A-Z][A-Z][A-Z])$/.exec(id);
        if ( ! iso_code_match ) {
            return
        }
        var iso_code = iso_code_match[1];
        var currency_sym = actionkit.utils.currencySymbols[iso_code];
        $('.ak-currency-sym').text( currency_sym || '' );
				$("#ak-amount-list").removeClass('currency-AUD currency-BRL currency-CAD currency-EUR currency-GBP currency-USD').addClass('currency-' + iso_code);
    }

    $(function() {
        $('input[id^=id_currency_], select[name="currency"], select[name="payment_account"]').on('change', redraw_currency_symbol);
        redraw_currency_symbol();
    });


    var address_fields = [
        'address1', 'address2', 'city', 'state', 'zip'
        {% if page.allow_international %}, 'postal', 'region', 'country'{% endif %}
    ];

    {% if page.allow_international %}
    function country_change() {
        if ( $('#country').val() == 'United States' ) {
            $('.ak-us-billing-fields').show().each(function(){
				$(this).children('input').prop('disabled', false);
			});
            $('.ak-intl-billing-fields').hide();
        } else {
            $('.ak-us-billing-fields').hide();
            $('.ak-intl-billing-fields').show().each(function(){
				$(this).children('input').prop('disabled', false);
			});
        }
        sync_to_shipping();
    }
    function shipping_country_change() {
        if ( $('#shipping_country').val() == 'United States' ) {
            $('.ak-us-shipping-fields').show();
            $('.ak-intl-shipping-fields').hide();
        } else {
            $('.ak-us-shipping-fields').hide();
            $('.ak-intl-shipping-fields').show();
        }
    }
    $( function () {
        $('#country').on('change blur', country_change);
        $('#id_shipping_country').on('change blur', shipping_country_change);
        country_change();
        shipping_country_change();
    } );
    {% endif %}


    function toggle_shipping() {
        if ( $('#ak-shipping-same').prop("checked") ) {
            sync_to_shipping();
            $('#ak-shipping-fields').slideUp();
            if($('.ak-shipping-required').length)
                $('.ak-shipping-required').remove();
        } else {
            clear_shipping();
            $('#ak-shipping-fields').slideDown();
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_address1' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_city' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_state' class='ak-shipping-required'>");
            $('#ak-shipping-fields').append(
                "<input type='hidden' name='required' value='shipping_zip' class='ak-shipping-required'>");
        }
    }

    function clear_shipping(e) {
        var i, field, ship_field;
        for (i in address_fields) {
            field = address_fields[i];
            ship_field = $('#id_shipping_' + field);
            ship_field.val("").change().prop("readonly", false);
        }
        {% if page.allow_international %}
        shipping_country_change();
        {% endif %}
    }

    function sync_to_shipping(e) {
        if ( ! $('#ak-shipping-same').prop("checked") ) {
            return;
        }
        var i, field, ship_field, bill_value;
        for (i in address_fields) {
            field = address_fields[i];
            ship_field = $('#id_shipping_' + field);
            bill_value = $('#id_' + field).val();
            ship_field.val(bill_value).change().prop("readonly", true);
        }
        {% if page.allow_international %}
        shipping_country_change();
        {% endif %}
    }

    $( function () {
        $('#ak-shipping-same').on('change', toggle_shipping);
        toggle_shipping();

        $('#id_address1, #id_address2, #id_city, #id_state, #id_zip, ' +
            '#id_region, #id_postal').on('change blur', sync_to_shipping);
    } );

    var three_step_initialized = 0;
    function three_step_reveal() {
        var current_step = $('input[name="ak-donate-step"]:checked').val();
        if ( current_step != "2" && current_step != "3" ) {
            current_step = "1"
        }
        var speed = three_step_initialized ? 1 : 400;
        if ( current_step == "1" ) {
          $('.ak-donate-area-step-2, .ak-donate-area-step-3').hide();
          $('.ak-donate-area-step-1, #ak-continue-button').fadeIn( speed );
					$('.ak-donate-step').removeClass('active-step');
					$('.ak-donate-step-1').addClass('active-step');

        } else if ( current_step == "2" ) {
          $('.ak-donate-area-step-1, .ak-donate-area-step-3').hide();
          /* this automatic focus on the input combines with the onblur validation to be over-aggressive
					$('.ak-donate-area-step-2, #ak-continue-button').fadeIn( speed,
              focus_field_if_blank( $('#id_name') )
          ); */
					$('.ak-donate-area-step-2, #ak-continue-button').fadeIn( speed );
					$('.ak-donate-step').removeClass('active-step');
					$('.ak-donate-step-2').addClass('active-step');
		    } else if ( current_step == "3" ) {
          $('.ak-donate-area-step-1, .ak-donate-area-step-2, #ak-continue-button').hide();
          /* $('.ak-donate-area-step-3').fadeIn( speed,
              focus_field_if_blank( $('#ak-card_num') )
          ); */
			    $('.ak-donate-area-step-3').fadeIn( speed );
					$('.ak-donate-step').removeClass('active-step');
					$('.ak-donate-step-3').addClass('active-step');
        }
    }

    function focus_field_if_blank ( field_elt ) {
        return ( function () {
            if ( ! field_elt.val() ) {
                field_elt.focus()
            }
        } )
    }

    var step_has_errors = false;
    function three_step_advance() {
				console.log('three_step_advance() fired');

        // trigger validation on the step we're leaving
        var current_step = $('input[name="ak-donate-step"]:checked').val();
        validate_step(current_step);

        if (!step_has_errors) {
          $('input[name="ak-donate-step"]:checked')
						.closest('label')
						.removeClass('active-step')
						.next('label')
						.addClass('active-step')
						.find('input[type="radio"]')
						.prop('checked', true);
		      three_step_reveal();
        }
    }

    function three_step_goto(next) {
			console.log('three_step_goto() fired');
	    // trigger va	lidation on the step we're leaving
	    var current_step = $('input[name="ak-donate-step"]:checked').val();

	    // skip validation if we're going backwards
	    if (current_step < next) {
	        validate_step(current_step);
	    }

	    // can't skip over a step unless it's already been completed
			console.log('three_step_goto: step_has_errors = ' + step_has_errors + ', current_step = ' + current_step + ', next = ' + next);
	    if ( (! step_has_errors) && (current_step == 1) && (next == 3) ) {
	      validate_step(2);
	      if ( step_has_errors ) {
	        $('#ak-donate-step-2').prop('checked', true);
	        three_step_reveal();
	        return;
	      }
	    }

	    // allow the user to go back even if there are errors
	    if (current_step > next || !step_has_errors) {
	      $('#ak-donate-step-' + next).prop('checked', true);
	      three_step_reveal();
	    }
	  }

    function validate_product_count ( field ) {
        var product_count = field.value;
        if (product_count == "" || product_count == "0") {
            return true
        }

        product_count = parseInt( product_count );
        if ( product_count < 1 ) {
            return actionkit.forms.errorMessage('product:choose');
        }
        var product_max = parseInt( $(field).attr('max') );
        if ( product_max && product_count > product_max ) {
            var err_msg = actionkit.forms.errorMessage('product:max');
            err_msg = err_msg.replace("{0}", product_max);
            return err_msg
        }
        return true
    }

		// even for recognized users we still need to require all user fields
    actionkit.forms.alwaysRequireUserFields = true;

    /* used to limit AK built-in validation to particular fields by step */
    var doing_step_validation = false;
    var validate_fields = [];
    function validate_step(step) {
      step_has_errors = false;
      if (step == "1") {
        validate_fields = ["amount"];
      } else if (step == "2") {
        validate_fields = ["email",
                           "address1", "address2", "city", "state", "zip",
                           "country", "region", "postal",
                           "shipping_address1", "shipping_address2",
                           "shipping_city", "shipping_state",
                           "shipping_zip", "shipping_country",
                           "shipping_region", "shipping_postal",
                           "privacy"
                           {% if has_candidates %},"action_employer", "action_occupation"{% endif %}];
      } else {
        validate_fields = ["card_num", "card_code", "first_name", "last_name", "name",
                           "exp_date_year", "exp_date_month", "exp_date"];
      }

      doing_step_validation = true;
      actionkit.forms.validate();
      doing_step_validation = false;

      if (step == "1") {
        step_has_errors = step_1_validation();
      }

      if (step == "2" && !step_has_errors) {
        step_has_errors = step_2_validation();
      }

      if (step == "3" && !step_has_errors) {
        step_has_errors = step_3_validation();
      }
    }

    function do_validate_credit_card() {
      if (actionkit.donations && actionkit.donations.skip_cc_validation) {
        return false;
      }
      return true;
    }

    function step_3_validation() {
      var step_has_errors = false;

      if (!do_validate_credit_card()) {
        return step_has_errors;
      }

      if (!valid_credit_card($('#ak-card_num').val())) {
        if (!actionkit.errors){
          actionkit.errors = {};
				}
        actionkit.errors['card_num:invalid'] = actionkit.forms.errorMessage('card_num:invalid');
        actionkit.forms.onValidationErrors(actionkit.errors);
        step_has_errors = true;
      }

      if (!valid_credit_card_code($('#ak-card_code').val())) {
        if (!actionkit.errors){
          actionkit.errors = {};
				}
        actionkit.errors['card_code:invalid'] = actionkit.forms.errorMessage('card_code:invalid');
        actionkit.forms.onValidationErrors(actionkit.errors);
        step_has_errors = true;
      }

      return step_has_errors;
    }

    function step_2_validation() {
			console.log('validating step 2');
      var step_has_errors = false;
      if (!valid_email( $('#id_email').val() ) ) {
        if (!actionkit.errors)
            actionkit.errors = {};
        actionkit.errors['email:invalid'] = actionkit.forms.errorMessage('email:invalid');
        actionkit.forms.onValidationErrors(actionkit.errors);
        step_has_errors = true;
      }

	     return step_has_errors;
    }

    function step_1_validation() {
			console.log('validating step 1.');
      var step_has_errors = false;

						/* If an opt-in option is not selected, show error */
						/* jQuery('#ak-continue-button').on('click',function(){
							console.log('#ak-continue-button clicked.');
					    if (!jQuery('input[name="privacy"]').is(':checked')) {
					        jQuery('.privacy-eu').addClass('privacy-ak-err');
					        jQuery('#privacy-error').show();
					        jQuery('input[name="privacy"]').click(function() {
										if(jQuery('input[name="privacy"]').is(':checked')) {
							        jQuery('.privacy-eu').removeClass('privacy-ak-err');
							        jQuery('#privacy-error').hide();
										}
									});
					    }
						}); */

      // look for product selections
      var selected_products = false;
      product_infos().forEach(function(info) {
        if (info.quantity) {
          selected_products = true;
        }
      });

      // look for candidate selections
      var selected_candidates = false;
      $('.ak_candidate_inputs').each(function(i) {
        if ($(this).val() != ""){
          selected_candidates = true;
				}
      });

      // there's no built-in validation for amounts, so do it here
      if (!selected_products && !selected_candidates &&
          !$('.ak-amount-radio-button').is(':checked') &&
          $('#ak-other-amount-field').val() == "") {
          if (!actionkit.errors)
              actionkit.errors = {};
          actionkit.errors['amount:missing'] = actionkit.forms.errorMessage('amount:missing');
          actionkit.forms.onValidationErrors(actionkit.errors);
          step_has_errors = true;

      } else if (($('#ak-other-amount-field').val() != "" &&
                  $('#ak-other-amount-field').val() != undefined)  &&
                 !/^\d*(\.\d{1,2})?$/.test($('#ak-other-amount-field').val())) {
          if (!actionkit.errors)
              actionkit.errors = {};
          actionkit.errors['amount:invalid'] = actionkit.forms.errorMessage('amount:invalid');
          actionkit.forms.onValidationErrors(actionkit.errors);
          step_has_errors = true;
      }

      {% if page.minimum_amount %}
      var total = update_total();
      if (!step_has_errors && total < {{ page.minimum_amount }}) {
          if (!actionkit.errors) {
              actionkit.errors = {};
          }
          err = actionkit.forms.errorMessage('amount:minimum');
          err = err.replace("{0}", "{{ page.minimum_amount }}");
          actionkit.errors['amount:minimum'] = err;
          actionkit.forms.onValidationErrors(actionkit.errors);
          step_has_errors = true;
      }
      {% endif %}

      return step_has_errors;
    }

    function actionkitValidationErrors(errors, field) {
        // only want this running during step validation
        if (!doing_step_validation) {
            return;
        }

        // trim out validation errors we don't care about on this step
        var to_delete = [];
        step_has_errors = false;
        for (var key in errors) {
            parts = key.split(':');
            if (validate_fields.indexOf(parts[0]) == -1) {
                to_delete.push(key);
            } else {
                step_has_errors = true;
            }
        }
        for (var i = 0; i < to_delete.length; i++) {
            delete errors[to_delete[i]];
        }
    }

    function three_step_initialize() {
		console.log('three_step_initialize() fired');
        if ($('.ak-err').is(":visible")) {
            var has_errors = [];
            if ($('.ak-donate-area-step-1').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-1'));
            }
            if ($('.ak-donate-area-step-2').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-2'));
            }
            if ($('.ak-donate-area-step-3').find('.ak-err').length) {
                has_errors.push($('.ak-donate-area-step-3'));
            }

            if (has_errors.length == 1) {
                // just one pane with errors?  show it
                has_errors[0].show();
            } else if (has_errors.length > 1) {
                // show all if errors on multiple steps
                $('.ak-donate-area-step-1, .ak-donate-area-step-2, .ak-donate-area-step-3').show();
                $('#ak-continue-button').hide();
            }
        }
        three_step_initialized = 1;
    }

    $(function() {
         // three-step vs. one-step UI
        if ( $('form.ak-donate-three-step').length == 0 ) {
            $('.ak-donate-three-step-visible').hide();
        } else {
            $('.ak-donate-three-step-hidden').hide();
            three_step_reveal();
            window.actionkitFormReady = three_step_initialize;
            // $('.ak-donate-menu input[type="radio"]').on('change', three_step_reveal);
            $('#ak-continue-button').on('click', function (evt) {
                // letting this event go will trigger our onsubmit and lead to validation woe
                evt.preventDefault();
                three_step_advance();
            });
            $('.ak-donate-step-1').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('1');
            });
            $('.ak-donate-step-2').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('2');
            });
            $('.ak-donate-step-3').on('click', function (evt) {
                evt.preventDefault();
                three_step_goto('3');
            });
        }
    });

    function product_ids() {
        return $("[data-product]").map(function(i, el) {
            return $(el).data("product");
        }).toArray();
    }

    function product_infos() {
        return product_ids().map(function(id) {
            return product_info(id);
        });
    }


// calculate subtotals if products exist
    function calculate_product_subtotals() {
        var subtotal = 0;
        product_infos().forEach(function(info) {
            $('.ak_product_subtotal_' + info.id).text(info.subtotal.toFixed(2));
            subtotal += info.subtotal;
        });
        $('#ak-donation-subtotal-amount').text(subtotal.toFixed(2));
    }

    $(function() {
        calculate_product_subtotals();

        $('.ak_product_inputs').on('change', function() {
            calculate_product_subtotals();
        });
    });

    // Standard luhn check to detect mistyped credit card numbers
    // from https://gist.github.com/DiegoSalazar/4075533
    function valid_credit_card(value) {
        if (/[^0-9-\s]/.test(value)) {
            return false;
        }
        var nCheck = 0, nDigit = 0, bEven = false;
        value = value.replace(/\D/g, "");

        for (var n = value.length - 1; n >= 0; n--) {
            var cDigit = value.charAt(n),
            nDigit = parseInt(cDigit, 10);

            if (bEven) {
                if ((nDigit *= 2) > 9) {
                    nDigit -= 9;
                }
            }

            nCheck += nDigit;
            bEven = !bEven;
        }

        return (nCheck % 10) == 0;
    }

    //calculate subtotals total
    function calculate_product_subtotals_total() {
        var amounts = [];
        for (var i = 1; i < $('#ak-product-list tr').length; i++) {
            var id = product_ids[i-1];
            amounts.push(parseFloat($('.ak_product_subtotal_'+id).text()));
            console.log(amounts);
            //subtotal =+ parseFloat($('.ak_product_subtotal_'+i).text());
            //console.log(subtotal+'is' + i);
        }
        // console.log(amounts);
        var subtotal = amounts.reduce(function (a, b) {return a + b;}, 0);
        // console.log(subtotal);
        $('#ak-donation-subtotal-amount').text(subtotal.toFixed(2));
    }

    $(function() {
        calculate_product_subtotals();
        $('.ak_product_inputs').on('change', function() {
            calculate_product_subtotals();
        });
    });

    // Standard luhn check to detect mistyped credit card numbers
    // from https://gist.github.com/DiegoSalazar/4075533
    function valid_credit_card(value) {
        if (/[^0-9-\s]/.test(value)) {
            return false;
        }
        var nCheck = 0, nDigit = 0, bEven = false;
        value = value.replace(/\D/g, "");

        for (var n = value.length - 1; n >= 0; n--) {
            var cDigit = value.charAt(n),
            nDigit = parseInt(cDigit, 10);

            if (bEven) {
                if ((nDigit *= 2) > 9) {
                    nDigit -= 9;
                }
            }

            nCheck += nDigit;
            bEven = !bEven;
        }

        return (nCheck % 10) == 0;
    }

    function valid_credit_card_code(value) {
        if (/[^0-9-\s]/.test(value)) {
            return false;
        }
        value = value.replace(/\D/g, "");
        if (value.length == 3 || value.length == 4) {
            return true;
        }
        return false;
    }

    // not 100% the same as Django but pretty close
    var email_regExp = /^\s*((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\s*$/i;
    function valid_email(email) {
        return email_regExp.test(email);
    }

    {% if show_paypal %}

    function submit_paypal() {
        {% if page.paypal_user_requirements != "none" %}
            {% if page.paypal_user_requirements == "email" %}
                validate_fields = ["email", "privacy"];
            {% else %}
                validate_fields = [
                    "email", "first_name", "last_name", "name",
                    "address1", "address2", "city", "state", "zip",
                    "country", "region", "postal",
                    "shipping_address1", "shipping_address2",
                    "shipping_city", "shipping_state",
                    "shipping_zip", "shipping_country",
                    "shipping_region", "shipping_postal",
										"privacy"
                    {% if has_candidates %},"action_employer", "action_occupation"{% endif %}
               ];
           	{% endif %}

           doing_step_validation = true;
           actionkit.forms.validate();
           doing_step_validation = false;
           if (!$.isEmptyObject(actionkit.errors)) {
               return false;
           }
        {% endif %}

        /* set the paypal=1 hidden field */
        $('#ak-pay-by-paypal').val(1);

        /* clear out CC info if entered */
        $('#ak-card_num').val('');
        $('#ak-card_code').val('');

        /* disable CC requirements */
        $('#ak-card_num-required').remove();
        $('#ak-card_code-required').remove();
        $('#ak-exp_date_month-required').remove();
        $('#ak-exp_date_year-required').remove();

        /* and keep submitting */
        return true;
    }

    function submit_cc() {
        /* clear paypal=1 hidden field, only needed if someone hit back */
        $('#ak-pay-by-paypal').val(0);

        if ( $('form.ak-donate-three-step').length > 0 ) {
            validate_step("3");

            if (step_has_errors) {
                return false;
            } else {
                return true;
            }
        }

        /* not doing 3-step, so we need to do all the validation here,
         * don't want to short-circuit and only run one step, better
         * to run all three even if all three have errors */
        actionkit.forms.validate();
        results = [step_1_validation(),
                   step_2_validation(),
                   step_3_validation()];
        return !(results[0] || results[1] || results[2]);
    }

    $( function () {
      $('#ak-paypal-button').on('click', submit_paypal);
    	$('.ak-submit-button').on('click', submit_cc);

      {% if page.paypal_user_requirements == "none" %}
        $('#ak-paypal-button').on('mousedown', function () {
            var form_elt = $(this).closest('form');
            var required_fields = form_elt.find('input[name="required"]');
            if ( required_fields.length ) {
                required_fields.remove();
                $('body').on('mouseup', function ( event ) {
                    form_elt.append( required_fields );
                    $( this ).unbind( event );
                } );
            }
        } );
      {% endif %}
    });
		{% endif %}

//-->
</script>

{% with page.payment_processor_information as pp %}
{% if pp.use_vzero %}
<style type="text/css">
.hosted-field {
  height: 50px;
  padding: 0px 7px;
  padding-top: 2em;
  margin-bottom:0.7em;
}
.hosted-field.braintree-hosted-fields-invalid {
  border-color: {{ templateset.custom_fields.color_error }};
  background: #fff0d4;
}
#ak-fieldbox-card_code{
	min-height: inherit;
}

#ak-fieldbox-card_code{
  margin:0;
  min-height:inherit;
  width:auto;
  margin-bottom: 20px;
}

.button{
  margin-top: 20px;
}

@media screen and ( min-width:720px ){
	#ak-fieldbox-card_code{
  	margin:0px 0 0 3%;
		width:49%;
  }
}


</style>
{% braintree_js_libs %}
<script src="/resources/ak_braintree_vzero.js"></script>
<script>
$(function() {
    var form = document.querySelector("#act"),
        options = {
            form: form,
            fields: {
                number: {
                    selector: '#ak-card_num-hosted'
                },
                cvv: {
                    selector: '#ak-card_code-hosted'
                },
                expirationDate: {
                    selector: '#ak-exp_date-hosted',
                    placeholder: 'MM / YYYY'
                }
            },
            styles: {
                'input': {
                    'font-family': '{{ templateset.custom_fields.font_family|default:"sans-serif"|safe }}',
                    'font-size': '1.1rem',
                    'font-weight': 'bold',
                    'color': '#17292e',
                    'padding': '0.6em'
                },
                'input.invalid': {
                    'color': '{{templateset.custom_fields.color_error }}',
                    'background-color': '#fff0d4'
                },
                'input.valid': {
                }
            },
            submitOnEmpty: function() {
                return $('#ak-pay-by-paypal').val() == 1;
            },
            submit: form.querySelector(".ak-submit-button")
        },
        toRemove = ["#ak-card_num", "#ak-card_code", "#ak-exp_date_month",
                    "#ak-exp_date_year", "#ak-card_num-required",
                    "#ak-card_code-required", "#ak-exp_date_month-required",
                    "#ak-exp_date_year-required"];

    toRemove.forEach(function(el) {
        $(el).remove();
    });

    actionkit.donations.handleError = function(err) {
        if (window.console) {
            window.console.log(err);
        }

        if (!actionkit.errors) {
            actionkit.errors = {};
        }

        switch (err.code) {
            case 'HOSTED_FIELDS_FIELDS_EMPTY':
                actionkit.errors['card_num:invalid'] = "Credit card fields are empty.";
                break;
          case 'HOSTED_FIELDS_FIELDS_INVALID':
                err.details.invalidFieldKeys.forEach(function(key) {
                    var map = {
                        'number': 'card_num',
                        'cvv': 'card_code',
                        'expirationDate': 'card_exp'
                    };
                    actionkit.errors[map[key] + ':invalid'] = "This field is invalid.";;
                });
                break;
          case 'HOSTED_FIELDS_FAILED_TOKENIZATION':
                actionkit.errors['card_num:invalid'] = "Please check that your credit card is valid.";
                break;
          case 'HOSTED_FIELDS_TOKENIZATION_NETWORK_ERROR':
                actionkit.errors['card_num:invalid'] = "Network error.";
                break;
          default:
                actionkit.errors['card_num:invalid'] = "An error occurred: " + err.message;
        }
        actionkit.forms.onValidationErrors(actionkit.errors);
    };

    actionkit.donations.initClient('{{ pp.client_token }}', options);

    // read by 3-step validation
    actionkit.donations.skip_cc_validation = true;
    actionkit.donations.vzero = true;

	$(".hosted-field.braintree-hosted-fields-invalid").prev().css("background-color", "#fff0d4")

});
</script>
{% endif %}
{% endwith %}

{% endblock %}
