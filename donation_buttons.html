{% block css_additions %}
<link href="https://dbqvwi2zcv14h.cloudfront.net/ak/donate.css" rel="stylesheet" type="text/css">
{% endblock %}

<div class="ak-amount-wrapper clearfix margin-bottom-small">
  <h5 class="margin-bottom-normal ak-donate-three-step-hidden" style="display: none;">Amount:</h5>
  <ul class="ak-unstyled nobullet text-large">
    {% for row in amounts|columns:1 %}
    {% for amount in row %}
    {% if amount == "other" %}
    <li id="ak-other-amount-container" class="c3_3 ct3_3 cm3_3 no-margin-bottom">
      <noscript>
        <input type="radio" value="" class="ak-amount-radio-button" name="amount">
      </noscript>
      <label for="ak-other-amount-field"
        class="input-radio-button input-radio-button-other bg-ltgray text-font-display text-large3 strong margin-bottom-small">
        <span class="ak-currency-sym">{{ page.currency_sym }}</span>
        <input type="number"
          onkeypress="return (event.charCode == 8 || event.charCode == 0) ? null : event.charCode >= 48 && event.charCode <= 57"
          id="ak-other-amount-field" class="text-font-display" name="amount_other" size="3">
      </label>
      <script>
        // Measures product impressions
        dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
        dataLayer.push({
          'event': 'impression',
          'ecommerce': {
          'impressions': [
           {
             'name': 'donation',
             'id': 'id_donation',
             'list': 'ak_donation_page',
             'variant': 'custom',
             'price': 'custom',
           }]
          }
        });
        </script>              
    </li>
    {% else %}
    <li class="ak-amount-container c3_3 ct3_3 cm3_3 no-margin-bottom">
      <label for="id_amount_{{amount}}"
        class="input-radio-button bg-ltgray text-font-display text-large3 strong margin-bottom-small">
        <span class="ak-currency-sym">{{ page.currency_sym }}</span><span
          class="ak-amount-button-amount">{{ amount|commify }}</span>
        <input type="radio" id="id_amount_{{amount}}" value="{{ amount }}"
          class="ak-amount-radio-button hidden" name="amount"
          {% if not args.amount_other and amount == default_amount %}checked{% endif %}>
      </label>
      <script>
        // Measures product impressions
        dataLayer.push({ ecommerce: null });  // Clear the previous ecommerce object.
        dataLayer.push({
          'event': 'impression',
          'ecommerce': {
          'impressions': [
           {
             'name': 'donation',
             'id': 'id_donation',
             'list': 'ak_donation_page',
             'variant': 'preset',
             'price': '{{amount}}',
           }]
          }
        });
        </script>              
    </li>
    {% endif %}
    {% endfor %}
    {% endfor %}
  </ul>
</div>

{% braintree_js_libs %}
<script src="/resources/ak_braintree_vzero.js"></script>
<script>
  $(function () {
    {% if not page.custom_fields.donation_only_paypal or page.custom_fields.donation_only_paypal.strip|lower != 'y' %}
    var form = document.querySelector("#act"),
      options = {
        form: form,
        fields: {
          number: {
            selector: '#ak-card_num-hosted'
          },
          cvv: {
            selector: '#ak-card_code-hosted'
          },
          expirationDate: {
            selector: '#ak-exp_date-hosted',
            placeholder: 'MM / YYYY'
          }
        },
        styles: {
          'input': {
            'font-family': '{{ templateset.custom_fields.font_family|default:"sans-serif"|safe }}',
            'font-size': '1.1rem',
            'font-weight': 'bold',
            'color': '#17292e',
            'padding': '0.6em'
          },
          'input.invalid': {
            'color': '{{templateset.custom_fields.color_error }}',
            'background-color': '#fff0d4'
          },
          'input.valid': {
          }
        },
        submitOnEmpty: function () {
          return $('#ak-pay-by-paypal').val() == 1;
        },
        submit: form.querySelector(".ak-submit-button")
      },
      toRemove = ["#ak-card_num", "#ak-card_code", "#ak-exp_date_month",
        "#ak-exp_date_year", "#ak-card_num-required",
        "#ak-exp_date_month-required",
        "#ak-exp_date_year-required", "#ak-card_code-required"];
    toRemove.forEach(function (el) {
      $(el).remove();
    });

    // Fix to stop donation errors gettin redirected from the error page
    actionkit.utils.appendHiddenInput('referer_from_url', '1');
    actionkit.donations.handleError = function (err) {
      if (window.console) {
        window.console.log(err);
      }
      if (!actionkit.errors) {
        actionkit.errors = {};
      }
      switch (err.code) {
        case 'HOSTED_FIELDS_FIELDS_EMPTY':
          actionkit.errors['card_num:invalid'] = "Credit card fields are empty.";
          break;
        case 'HOSTED_FIELDS_FIELDS_INVALID':
          err.details.invalidFieldKeys.forEach(function (key) {
            var map = {
              'number': 'card_num',
              'cvv': 'card_code',
              'expirationDate': 'card_exp'
            };
            actionkit.errors[map[key] + ':invalid'] = "This field is invalid.";;
          });
          break;
        case 'HOSTED_FIELDS_FAILED_TOKENIZATION':
          actionkit.errors['card_num:invalid'] = "Please check that your credit card is valid.";
          break;
        case 'HOSTED_FIELDS_TOKENIZATION_NETWORK_ERROR':
          actionkit.errors['card_num:invalid'] = "Network error.";
          break;
        default:
          actionkit.errors['card_num:invalid'] = "An error occurred: " + err.message;
      }
      actionkit.forms.onValidationErrors(actionkit.errors);
    };
    actionkit.donations.initClient('{{ pp.client_token }}', options);
    // read by 3-step validation
    actionkit.donations.skip_cc_validation = true;
    actionkit.donations.vzero = true;
    $(".hosted-field.braintree-hosted-fields-invalid").prev().css("background-color", "#fff0d4");
    {% endif %}
  });
</script>
{% endif %}
{% endwith %}