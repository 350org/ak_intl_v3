{% extends "./wrapper.html" %}
{% load actionkit_tags smartif %}
{% block content %}

<style>
#page-header{
  margin-bottom:-3em;}
#event-search-box{
  border-radius:0;
  padding:0.6em;}
#event-search-box label{
  background:#fff;
  display:block;
  font-size:0.8rem;
  padding:0.4em 0.6em 0;}
#event-search-postal-wrapper,
#event-search-country-wrapper,
#event-search-submit{
  text-align:left;}
#event-search-postal-wrapper input,
#event-search-country-wrapper select{
  border-width:0;
  font-size:1.3rem;
  height:45px;
  padding:0.2em 0.5em 0.4em;}
#event-search-postal-wrapper input:focus,
#event-search-country-wrapper select:focus{
  box-shadow:0 2px 0 #0f81e8;
  outline:none;}
#event-search-submit{
  border-radius:3px;
  font-size:1.1rem;
  height:55px;
  text-align:center;
  width:100%;}
#event-list{
  padding:0;}
#event-search-results-wrapper{
  padding:2.5em 1.3em;}
a.area-link.event-link:hover {
  box-shadow: 0 0 0 20px rgba(0,0,0,0.05);
  background: rgba(0,0,0,0.05);}
#event-map{
  height:300px;
  max-height:60vh;
  position:relative;}
#map_canvas{
  height:100%;}
#event-search-postal-wrapper input{
}
#event-search-country-wrapper select{
}
@media screen and (min-width:900px){

  #page-header{
    margin-bottom:-4em;}
  #event-search-form{
    display:flex !important;
    font-size:0;}
  #event-search-postal-wrapper,
  #event-search-country-wrapper,
  #event-search-submit{
    display:inline-block;
    vertical-align:text-top;}
  #event-search-postal-wrapper{
    flex-grow:1;
    width:50%;}
  #event-search-country-wrapper{
    margin-left:1%;
    width:29%;}
  #event-search-postal-wrapper input,
  #event-search-country-wrapper select{
    margin-bottom:0;}
  #event-search-submit{
    height:72px;
    margin-left:1%;
    width:19%;}

  #event-search-results-wrapper{
    padding:3em;}

  #event-map{
    height:calc(100vh - 110px);
    max-height:100vh;
    padding:3em 3em 3em 0;}
  .is-sticky #event-map{
    width:40% !important;}

}
</style>
<div id="page-header" class="section width-normal padding-large text-center bg-{% if page.custom_fields.page_background_color %}{{ page.custom_fields.page_background_color }}{% else %}white{% endif %}{% if page.custom_fields.page_background_image %}-fade{% endif %}">
  <div class="section-inner">
{% if page.custom_fields.page_pretitle %}
    <p id="action-pretitle" class="text-font-secondary"><span class="highlight bg-dkgray-trans">{{ page.custom_fields.page_pretitle }}</span></p>
{% endif %}
    <h2 id="action-title" class="text-style-title-large title3">
{% if page.custom_fields.page_title_custom_html %}
  {% autoescape off %} {{ page.custom_fields.page_title_custom_html }} {% endautoescape %}
{% else %}
      <span class="{{ page.custom_fields.page_title_style }}">{{ page.title }}</span>
{% endif %}
    </h2>
    <div class="text-style-lead2 text-large2 margin-bottom-huge" data-read-more-after="{% if page.custom_fields.page_description_readmore %}{{ page.custom_fields.page_description_readmore }}{% else %}1{% endif %}">
      {{ form.search_page_text|safe }}
    </div>

  </div>
</div>

<div class="section bg-white notch width-full padding-none">
<div id='map-embed-350org' 
class="padding-medium" 
data-src-latlong={% if page.custom_fields.event_search_map_center %}{{ page.custom_fields.event_search_map_center }}{% else %}13.076647312917522, 28.828125{% endif %}} style='height: 80vh' data-src-layers="events" data-src-zoom=3></div>
</div>
{% include "./social_plugins.html" %}
{% endblock %}

{% block tail_js %}
<script type="text/javascript">
      RAH = {};
      RAH.sprite_url = "https://350-ak-map-assets.netlify.com/images/marker-single.png";
      RAH.multiple_sprite_url = "https://350-ak-map-assets.netlify.com/images/marker-cluster.png";
      // Add locations for plotting on the map
      RAH.event_locations = [];
      RAH.map_center = {};
</script>
<script type="text/javascript" src="https://s3.amazonaws.com/s3.350.org/js/map/markerclusterer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" integrity="sha256-4iQZ6BVL4qNKlQ27TExEhBN1HFPvAvAMbFavKKosSWQ=" crossorigin="anonymous"></script>
<script type="text/javascript">

</script>
<script type="text/javascript">
/**
window.mapEvents = [
{% for event in campaign.event_set.all.select_related %}
{% if not event.is_private %}{% if event.host_is_confirmed and event.status == "active" %}{% if event.is_approved or not campaign.require_staff_approval %}
{
"event_id": "{{ event.id }}", "created_at": "{{ event.created_at }}", "updated_at": "{{ event.updated_at }}", "address1": "{{ event.address1 }}", "address2": "{{ event.address2 }}", "city": "{{ event.city }}", "state": "{{ event.state }}", "region": "{{ event.region }}", "postal": "{{ event.postal }}", "zip": "{{ event.zip }}", "plus4": "{{ event.plus4 }}",
"country": "{{ event.country }}", "longitude": {% if event.custom_fields.geocoded_longitude %}{{ event.custom_fields.geocoded_longitude }} {% else %}{{ event.longitude }}{% endif %}, "latitude": {% if event.custom_fields.geocoded_latitude %}{{ event.custom_fields.geocoded_latitude }} {% else %}{{ event.latitude }}{% endif %}, "campaign_id": "{{ event.campaign_id }}", "title": "{{ event.title }}", "creator_id": "{{ event.creator_id }}", "starts_at": "{{ event.starts_at|date:'c' }}", "ends_at": "{{ event.ends_at|date:'c' }}", "status": "{{ event.status }}", "host_is_confirmed": "{{ event.host_is_confirmed }}", "is_private": "{{ event.is_private }}", "is_approved": "{{ event.is_approved }}", 
"attendee_count": "{{ event.attendee_count }}", "max_attendees": "{{ event.max_attendees }}", "venue": "{{ event.venue }}", 
"public_description": "{{ event.public_description|linebreaksbr|escapejs }}",
"directions": "{{ event.directions|linebreaksbr|escapejs }}",
"note_to_attendees": "{{ event.note_to_attendees|linebreaksbr|escapejs }}",
{% if event.custom_fields.event_facebook_id and event.custom_fields.event_facebook_id != "none" %}"facebook_id": "{{ event.custom_fields.event_facebook_id }}",{% endif %}
"notes": "{{ event.notes|linebreaksbr|escapejs }}"
},
{% endif %}{% endif %}{% endif %}
{% endfor %}
0
];
window.mapEvents = window.mapEvents.slice(0, -1);

function initData(geocoded_events, offsite_events) {
  if( offsite_events.length ) {
    window.mapEvents.push.apply(window.mapEvents, offsite_events);
  }

  for( var i=0; i<window.mapEvents.length; ++i ) {
    var event_id = window.mapEvents[i].event_id;
    if( geocoded_events[event_id] ) {
      window.mapEvents[i].latitude = geocoded_events[event_id].latitude;
      window.mapEvents[i].longitude = geocoded_events[event_id].longitude;
    }
  }
  loadMap(window.mapEvents);
console.log('initData called.');
};

var $sel = function(selector) {
    if ( actionkit.multiForms && actionkit.form )
        return $(actionkit.form).find(selector);
    return $(selector);
};

var featured_events = [], featured_events_ready = false, featured_events_highlighted = false;

function fitMapToEvents(el) {
  var events = el.find("li[data-event_id]");
  if( !events || !events.length ) {
    gmap.setZoom(myOptions.zoom);
    gmap.setCenter(myOptions.center);
    return;
  }
  var fitBounds = new google.maps.LatLngBounds();
  for( var i=events.length-1; i>=0; --i ) {
    var event = events[i];
    var arrayPosition = $.inArray($(event).data("event_id"), $.map(mapEvents, function(el){ return parseInt(el.event_id); }));
    if( arrayPosition != -1 ) {
      var entry = mapEvents[arrayPosition];
      fitBounds.extend(new google.maps.LatLng(entry.latitude, entry.longitude));
    }
  }
  gmap.fitBounds(fitBounds);
  if( gmap.getZoom() > 17 ) { gmap.setZoom(17); }
}

actionkit.forms.onEventSearchResults = function(html) {
  try {
    var el = $("<div>").html(html);
    if( featured_events_ready ) {
      highlightFeaturedEvents(el);
    }
    fitMapToEvents(el);
    html = el.html();
  } finally {
    $sel('#event-search-results, .event-search-results').html(html);
  }
};
$(window).load(function() {
	initData([], []);
});
**/
</script>

{% endblock %}
