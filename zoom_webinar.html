{% load actionkit_tags smartif %}

<div class="section bg-white form-style-expanded width-normal padding-medium">
    <div class="section-inner">
    <h3 class="section-header meta margin-bottom-large">{% filter ak_text:"event_create_section_location" %}Webinar Information{% endfilter %}</h3>
    <button class='zoom-webinar-btn' id="create-webinar">Make it a Zoom Webinar</button>
    </div>
    <div id="zoom-details">
            <div class="section-inner">
        <fieldset id="webinar-details">
            <div class="input-text ak-input-type-event input-address">
                <label for="id_webinar_password">{% filter ak_text:"webinar_password"|capfirst %}Webinar Password{% endfilter %}</label>
                <input id="id_webinar_password" type="password" name="webinar_password"/>
            </div>

            <div class="input-text ak-input-type-event input-address">
                <label for="id_webinar_confirm_password">{% filter ak_text:"webinar_confirm_password"|capfirst %}Webinar Confirm Password{% endfilter %}</label>
                <input id="id_webinar_confirm_password" type="password" name="webinar_confirm_password"/>
            </div>
            <div class="input-text ak-input-type-event input-address">
                <label for="id_webinar_duration">{% filter ak_text:"webinar_duration"|capfirst %}Webinar Duration{% endfilter %}</label>
                <input id="id_webinar_duration" type="number" min="30" max="120" name="webinar_duration"/>
            </div>
            {% comment %} <div class="input-text ak-input-type-event input-address">
                <label for="id_webinar_timezone">{% filter ak_text:"webinar_timezone"|capfirst %}Webinar Timezone{% endfilter %}</label>
                <input id="id_webinar_timezone" type="number" min="30" max="120" name="webinar_timezone"/>
            </div> {% endcomment %}
            <button class="zoom-webinar-btn" id="submit-webinar-details">Get Webinar Link</button>
            <div id="webinar-errors"></div>
        </fieldset>
        </div>
    </div>
    <div class="section-inner">
        <div id="zoom-success">

        </div>
    </div>
</div>
<script>
    // Use get token and store it in local storage instead of this 
    $(document).ready(function($){
    const zoomSuccess = $("#zoom-success");
    // API CALL
    function makeAPICall(payload){
        const token = localStorage.getItem("token");
        if(!token){
            console.log("No JWT toke found")
            return
        };
        const options = {
                method: 'POST',
                headers: {
                    'User-Agent': 'Zoom-Jwt-Request',
                    'Content-Type': 'application/json',
                    'Authorization' : token
                },
        body: JSON.stringify(payload),
        json: true
        };

        // console.log(options, "Here???")
        fetch(`https://zaki-server.herokuapp.com/api/v1/webinars`, options)
        .then(response=>{
            if(response.ok){
                webinarErrors.hide();
                zoomDetails.hide();
                response.json().then(data=>{ 
                    console.log(data, "fdsa")
                    zoomSuccess.append(`<div class="webinar-details section-inner">
                    <p>Follow <a href=${data.data.join_url}>this</a> link to go to the webinar.</p>
                    Alternatively, copy this information and share:
                    <br/>
                    Join : ${data.data.join_url}
                    <br/>
                    Password: ${data.data.password || ""}
                    </div>`
                    )
                })
            } else {
                throw Error("Creation of webinar failed")
            }
        })
        .catch(e=>{
            console.log("Error"+ e);
        })
    }
    // API CALL
    const dayjs = window.dayjs;
    const zoomDetails = $("#zoom-details");
    const webinarErrors = $("#webinar-errors");
    webinarErrors.hide();
    zoomDetails.hide();
    $('#create-webinar').one("click", (event)=>{
        $('#create-webinar').hide();
        zoomDetails.show();
        event.preventDefault();
    })

    let errors = [];
    $('#submit-webinar-details').on("click", event=>{
        event.preventDefault();
        const timezone = $("#id_webinar_password").val();
        const password = $("#id_webinar_password").val();
        const duration = $("#id_webinar_duration").val();
        const agenda = $("#id_event_public_description").val();
        const confirmPassword = $("#id_webinar_confirm_password").val();
        const topic = $("#id_event_title").val().trim();
        const date = $("#id_event_starts_at_date").val();
        const time = $("#id_event_starts_at_time").val();
        const dateFormat = dayjs(date).format("YYYY-MM-DD");
        const start_time = `${dateFormat}T${time}:00`;
        const payload = {
            topic,
            type: 5,
            start_time,
            duration: Number(duration),
            timezone: "America/Los_Angeles",
            password,
            agenda
        };
        makeAPICall(payload);
    });
    // act: R15o7-M4RO6l3yNf2Jp0rw

    })
</script>