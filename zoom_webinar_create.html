<!--Zoom Webinar Section -->
<div class="input-textarea ak-input-type-event id_event_public_description margin-bottom-none">
<label for="id_event_public_description">{% filter ak_text:"event_create_field_label_description" %}Webinar Details{% endfilter %}</label>
    <p class="text-small opacity-50">
        This webinar link will be prefilled into the venue section and be used to access the event.
    </p>
<fieldset id="webinar-details">
    <div class="full-length">
    <div class="input-text ak-input-type-event input-address half-full">
        <label for="id_webinar_duration">{% filter ak_text:"webinar_duration"|capfirst %}Webinar Duration (In Minutes){% endfilter %}</label>
        <select id="id_webinar_duration" type="number" min="30" max="120" name="webinar_duration">
        </select>
    </div>
    <div class="input-text ak-input-type-event input-address half-full">
        <label for="id_webinar_timezone">{% filter ak_text:"webinar_timezone"|capfirst %}Webinar Timezone{% endfilter %}</label>
        <select id="id_webinar_timezone" type="text" min="30" max="120" name="webinar_timezone">

        </select>
    </div>
    </div>
    <button class="zoom-webinar-btn" id="add-webinar-link">Add Webinar Link</button>
    <ul id="webinar-errors"></ul>
</fieldset>
    <div class="section-inner">
        <div id="zoom-success">

        </div>
    </div>
</div>
<!--Zoom Webinar Section -->

{% block scripts %}
    <!-- block.super will get the content of the block from the parent template -->
    <script>
        $(function() {
        // Hide any errors first
        $("#webinar-errors").hide();
        // Get token
        fetch(`https://zaki-server.herokuapp.com/api/v1/auth`).then(response=>{
          if(response.ok){
            response.json().then(data=>{
              localStorage.setItem("token", data.token);
            })
          } else {
            throw new Error("Response not ok.")
          }
        }).catch(e=>{
          console.log(`Auth error: ${e.message}.`)
        });
        // API CALL
        const zoomDetails = $("#webinar-details");
        const webinarErrors = $("#webinar-errors");
        const zoomSuccess = $("#zoom-success");
        function makeAPICall(payload){
            const token = localStorage.getItem("token");
            if(!token){
                console.log("No JWT token found")
                return
            };

            const options = {
                method: 'POST',
                headers: {
                    'User-Agent': 'Zoom-Jwt-Request',
                    'Content-Type': 'application/json',
                    'Authorization' : token
                },
                body: JSON.stringify(payload)
            };

            fetch(`https://zaki-server.herokuapp.com/api/v1/webinars`, options)
            .then(response=>{
                if(response.ok){
                    webinarErrors.hide();
                    zoomDetails.hide();
                    response.json().then(data=>{ 
                        // add the url to the address
                        $("#id_event_address1").val(`Link: ${data.data.join_url} , Password: ${data.data.password || ""}`);
                        $("#id_event_venue").val("Via Zoom Webinar");
                        zoomSuccess.append(`<div class="webinar-details">
                        <p>Your webinar has been created! The zoom link is pre-filled below, and will be visible to attendees after they sign up.</p>
                        `
                        )
                    })
                } else {
                    throw Error("Creation of webinar failed")
                }
            })
            .catch(e=>{
                $("#webinar-errors").show()
                $("#webinar-errors").append('<li>Oops! An error occurred when generating the link for your webinar. Please try again later. If this persists contact: web@350.org</li>');
            })
        }
        // API CALL
        // simple cache
        let timezonesList = [];

        function addTimezonesOptions(list){
          list.sort((a,b)=>{
            return a.name > b.name? 1: -1
          });
          list.forEach(timezone =>{
            $("#id_webinar_timezone").append(`<option value=${timezone.id}>${timezone.name}</option>`);
          });

          // Dropdown
          $( "#id_webinar_timezone" ).selectmenu();
        };

        function generateZoomWebinarPassword(length) {
            let result  = '';
            let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let charactersLength = characters.length;
            for ( let i = 0; i < length; i++ ) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        };
    
        if(timezonesList.length){
           addTimezonesOptions(timezonesList);
        } else {
          fetch(`https://zaki-server.herokuapp.com/api/v1/timezones`)
          .then(response=>{
              if(!response.ok) throw new Error("Response not ok.")
              // store in cache timezoneslist
              response.json()
              .then(data=>{
                timezonesList = data.data;
                console.log(timezonesList, "timezones")
                addTimezonesOptions(timezonesList);
              });
          })
          .catch(error=>{
              console.log(`Auth error: ${e.message}.`)
          });
        };
      

        const durationList = [
          {
            displayText: "30 minutes",
            value: "30"
          },
          {
            displayText: "1 hour",
            value: "60"
          },
          {
            displayText: "1hour 30 minutes",
            value: "90"
          },
          {
            displayText: "2hours",
            value: "120"
          }
        ];


        const errorKeys = [
          {
            key: 1,
            value: "Event name is required.",
          },
          {
            key: 2,
            value: "Event description is required.",
          },
          {
            key: 3,
            value: "Event start time is required.",
          },
          {
            key: 4,
            value: "Event date is required.",
          },
        ]

        // Menu for duration
        durationList.forEach(duration=>{
           $("#id_webinar_duration").append(
            `<option value=${duration.value}>${duration.displayText}</option>`
           )
        });

        $( "#id_webinar_duration" ).selectmenu();

        let errors = [];
        const resetErrors = () => {
          return errors = [];
        }

        const showWebinarErrors = () => {
           errors = Array.from(errors);
           if(errors.length){
             $("#webinar-errors").show()
             errors.forEach(error=>{
               $("#webinar-errors").append(`<li>${errorKeys[error].value}</li>`);
             });
           } else {
             errors = []
             $("#webinar-errors").hide()
           }
        }
        const validateZoomPayload = (topic, agenda, time, date) => {
            console.log(errors, "before valdate")
            errors = new Set(errors)
            if(topic.length === 0 ){
              errors.add(errorKeys[0].key)
            }

            if(agenda.length === 0){
              errors.add(errorKeys[1].key)
            };

            if(!time){
              errors.add(errorKeys[2].key)
            }
            if(!date) {
              errors.add(errorKeys[3].key)
            }

            return errors;
        }

   
        // Add Webinar Link
        $("#add-webinar-link").on("click", event=>{
            console.log("clicked")
            resetErrors();
            event.preventDefault();
            const timezone = $("#id_webinar_timezone").val();
            const duration = $("#id_webinar_duration").val();
            const agenda = $("#id_event_public_description").val();
            const topic = $("#id_event_title").val().trim();
            const date = $("#id_event_starts_at_date").val();
            const time = $("#id_event_starts_at_time").val();
            const amPm = $("#id_event_starts_at_ampm").val();
            const dateFormat = moment(date, "MM-D-YYYY").format("YYYY-MM-DD");
            const start_time = moment(`${dateFormat} ${time}:00 ${amPm}`, 'YYYY-MM-DD hh:mm:ss A').format('HH:mm:ss');
            const start_date = moment(`${dateFormat} ${time}:00 ${amPm}`, 'YYYY-MM-DD hh:mm:ss A').format('YYYY-MM-DD');
            const zoomStartTime = `${start_date}T${start_time}`;
            // let errors = []
            errors = validateZoomPayload(topic, agenda, time, date);
            if(errors.size){
               showWebinarErrors();
            } else {
              errors = new Set([])
              showWebinarErrors
              const payload = {
                  topic,
                  type: 5, // Zoom Docs req.
                  start_time: zoomStartTime,
                  duration,
                  timezone,
                  password: generateZoomWebinarPassword(4),
                  agenda
              }; 
              makeAPICall(payload);
            }
    
        });
    });
    </script>
{% endblock %}