{% extends "./wrapper.html" %}
{% load actionkit_tags %}
{% block content %}
<style>
#section-webinars {
  background-position: center center;
  background-size: cover;
  position: relative;
  padding: 0;
}
.single-webinar-item-ctn{
    display: flex;
    width: 100%;
    max-height: auto;
    padding: 1.5em;
    align-items: center;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.single-webinar-item-ctn .left {
  max-width: 5.5em;
}

.single-webinar-item-ctn .middle {
  min-width: 80%;
  max-width: 80%;
}


.single-webinar-item-ctn .left {
    align-items: center;
    display: flex;
    flex-direction: column;
    height: 100%;
    border-right: 1px solid rgba(0,0,0,0.1);
    padding: 1em;
    margin: 0 1em 0 0;
    min-width: 5em;
}

.single-webinar-item-ctn .left .webinar-date{
  font-size: xx-large;
}
.single-webinar-item-ctn .left .webinar-day{
  text-transform: uppercase;
}

.webinar-day, .webinar-date {
  color: rgba(0,0,0,0.5);
}
.search-section {
    background: rgb(15,129,233);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction:column;
    padding: 2.5em 0;
    margin-bottom: 1em;
}

.search-section h4 {
  color: white;
  text-transform: uppercase;
  margin-bottom: 1em;
}

.search-ctn {
    width: 55%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 0 10px;
}

.search-ctn input {
  border: none;
}

.search-ctn input:focus {
  outline: none;
}

.search-ctn input::placeholder {
  outline: none;
  font-weight: normal;
}

.search-ctn button {
  border-radius: 2px;
}

.rsvp-webinar {
    background: white;
    border: 3px solid black;
    color: black !important;
    text-shadow: none !important;
    padding: .5em 2em;
    text-decoration: none;
    border-radius: 35px;
}

#loading-text{
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
}

.date-filters {
    display: flex;
    justify-content: center;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    font-weight: bold;
    font-size: small;
    margin-bottom: 2em;
}
.date-filters span {
  padding: 1em;
  transition: 0.1s all ease-in-out;
}

.active {
  background: rgb(15,129,233, 0.1);
}

.date-filters span:hover {
  background: rgb(15,129,233, 0.1);
  cursor: pointer;
}

#no-webinars {
  text-align: center;
}

#simple embed process

        .lds-default {
            display: inline-block;
            position: relative;
            width: 64px;
            height: 64px;
        }

        .lds-default div {
            position: absolute;
            width: 5px;
            height: 5px;
            background: #0F81e9;
            border-radius: 50%;
            animation: lds-default 1.2s linear infinite;
        }

        .lds-default div:nth-child(1) {
            animation-delay: 0s;
            top: 29px;
            left: 53px;
        }

        .lds-default div:nth-child(2) {
            animation-delay: -0.1s;
            top: 18px;
            left: 50px;
        }

        .lds-default div:nth-child(3) {
            animation-delay: -0.2s;
            top: 9px;
            left: 41px;
        }

        .lds-default div:nth-child(4) {
            animation-delay: -0.3s;
            top: 6px;
            left: 29px;
        }

        .lds-default div:nth-child(5) {
            animation-delay: -0.4s;
            top: 9px;
            left: 18px;
        }

        .lds-default div:nth-child(6) {
            animation-delay: -0.5s;
            top: 18px;
            left: 9px;
        }

        .lds-default div:nth-child(7) {
            animation-delay: -0.6s;
            top: 29px;
            left: 6px;
        }

        .lds-default div:nth-child(8) {
            animation-delay: -0.7s;
            top: 41px;
            left: 9px;
        }

        .lds-default div:nth-child(9) {
            animation-delay: -0.8s;
            top: 50px;
            left: 18px;
        }

        .lds-default div:nth-child(10) {
            animation-delay: -0.9s;
            top: 53px;
            left: 29px;
        }

        .lds-default div:nth-child(11) {
            animation-delay: -1s;
            top: 50px;
            left: 41px;
        }

        .lds-default div:nth-child(12) {
            animation-delay: -1.1s;
            top: 41px;
            left: 50px;
        }

        @keyframes lds-default {

            0%,
            20%,
            80%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.5);
            }
      }

</style>
<div id="section-webinars" class="bg-white form-style-expanded width-normal">
    <div class="section search-section">
    <h4>350 Webinars</h4>
    <div class='search-ctn'>
    <input type="search" id="search-webinars" name="s" class="search-form-field c7" value="" placeholder="Search webinars by topic...">
    <button id="search-webinars-btn" class='button button-primary'>SEARCH</button>
    </div>

    </div>
    <div class="section-inner">
    <div class="date-filters">
      <span id="all" class="webinar-date-filter active">Filter ALL</span>
      <span id="today" class="webinar-date-filter">TODAY</span>
      <span id="week" class="webinar-date-filter">THIS WEEK</span>
      <span id="month" class="webinar-date-filter">THIS MONTH</span>
    </div>
    <ul id="ak-campaign-list">
    <div id="loading-text">
              <div class="lds-default">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
    </div>
    </div>
    </ul>
    <br/>
    </div>
    <div id="no-webinars" class="section-inner">
    <h5>No webinars found</h5>
    <p>We can't find any webinars based on your filter.</p>
    </div>
</div>
{% endblock %}

{% block script_additions %}
<script type="text/javascript">
      $(document).ready(function() {
        // Embed functionality is here
        console.log(window.location, "ref")
        const url = new URL(window.location);
        console.log(url.searchParams.get('region'), "here???")
        // Embed functionality ends here
        // Cache the campaign events here.
        let campaignEvents = [];
        let campaignDetails = {};
        let filteredCampaignEvents = [];
        // Get token and set it in local storage
        const token = localStorage.getItem("token");
        // $("#search-webinars").hide();
        $("#no-webinars").hide();
        const listCtn = $("#zoom-webinar-list")
        if(!token){
            console.log("ZAKI access token missing.")
            return;
        }
        fetch("https://zaki-server.herokuapp.com/api/v1/ak-webinar-campaigns?campaignId=187", {
          headers: {
            authorization: token
          }
        }, ()=>{

        }).then(data=>{
          if(data.ok){
            data.json().then(response=>{
              campaignEvents = response.data.campaignEvents;
              campaignDetails = response.data.campaignDetails;
              $("#search-webinars").show();
              showCampaignEvents(campaignEvents, campaignDetails);
            })
          }
        })
        .catch(e=>{
          console.log(e, "Error")
        });
        // Grab the campaign events.
        // Function
        const showCampaignEvents = (campaignEvents, campaignDetails) => {
          // Sort the list in descending order here.
          campaignEvents.objects.sort((a, b)=>( moment(a.starts_at).valueOf() > moment(b.starts_at).valueOf())? 1 : -1);
          if(campaignEvents.objects.length === 0){
              $("#no-webinars").show();
              return;
          }
          $("#no-webinars").hide();
          console.log(campaignEvents, "here")
          for(let i = 0 ; i < campaignEvents.objects.length ; i ++){
            const webinarAk = campaignEvents.objects[i];
            console.log(webinarAk, "here we goes")
              $("#loading-text").hide();
              $("#ak-campaign-list").append(`<li class="single-webinar-item-ctn">
                <div class='left'>
                <span class='webinar-day'>${window.moment(webinarAk.starts_at).format("ddd")}</span>
                <span class='webinar-date'>${window.moment(webinarAk.starts_at).format("D")}</span>
                <span class='webinar-day'>${window.moment(webinarAk.starts_at).format("MMM")}</span>
                </div>
                <div class='middle'>
                <h4>${webinarAk.title}</h4>
                <p>${window.moment(webinarAk.starts_at).format("ddd D MMM YYYY - HH:mm a ZZ")}</p>
                <p>${webinarAk.public_description || "No agenda set yet for this webinar."}</p>
                </div>
                <p class='right'>
                <a class="join-btn rsvp-webinar" target="__blank" href="https://act.350.org/event/${campaignDetails.name}_attend/${webinarAk.id}"> RSVP </a>
                </p>
              </li>`) 
          }
        };

        const filterBySearchTerm = searchTerm => {
          if(searchTerm.length > 0){
          const isFiltered = $('#today').hasClass('active') || $('#week').hasClass('active') || $('#month').hasClass('active');
          const campaignList = isFiltered ? filteredCampaignEvents : campaignEvents;
          const filteredObjects = campaignList.objects.filter(event=>{
              return event.title.toLowerCase().replace(/ /g,"").trim().indexOf(searchTerm.toLowerCase().replace(/ /g,"").trim()) > -1
            });
          filteredCampaignEvents = {
            objects: filteredObjects
          }
          $("#ak-campaign-list").empty()
          showCampaignEvents(filteredCampaignEvents, campaignDetails)
          } else {
          const isFiltered = $('#today').hasClass('active') || $('#week').hasClass('active') || $('#month').hasClass('active');
          const campaignList = isFiltered ? filteredCampaignEvents : campaignEvents;
          $("#ak-campaign-list").empty()
          showCampaignEvents(campaignList, campaignDetails)
          }
        };

        // search section
        $("#search-webinars").on('input', (event)=>{
          const searchTerm = event.target.value;
          filterBySearchTerm(searchTerm);
        });

        // search section
        // Adding this for the sake.
        $("#search-webinars-btn").on('click', ()=>{
          const searchTerm = $("#search-webinars").val();
          filterBySearchTerm(searchTerm);
        });

        const removeActiveOnDateFilters = () => {
          $( ".webinar-date-filter" ).each(function() {
              $( this ).removeClass( "active" );
          });
        };

        const isBetween = (date, start, end) => {
            return date.isBetween(start, end)
        };

        const filterByDate = period => {
          removeActiveOnDateFilters();
          $(`#${period}`).addClass( "active" );
          if(campaignEvents && campaignEvents.objects && campaignEvents.objects.length){
            const filteredObjects = campaignEvents.objects.filter(event=>{
              return isBetween(moment(event.starts_at_utc), moment().utc().startOf(period), moment().utc().endOf(period))
            });
          filteredCampaignEvents = {
            objects: filteredObjects
          }
          $("#ak-campaign-list").empty()
          showCampaignEvents(filteredCampaignEvents, campaignDetails)
          }
        };

        

        $("#all").on("click", event=>{
          removeActiveOnDateFilters();
          $("#all").addClass( "active" );
          $("#ak-campaign-list").empty()
          showCampaignEvents(campaignEvents, campaignDetails)
        });

        $("#today").on("click", event=>{
          filterByDate("today");
        });

        $("#week").on("click", event=>{
          filterByDate("week");
        });

        $("#month").on("click", event=>{
          filterByDate("month");
        });
      })
</script>
{% endblock %}